<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Identificação - Tarugos e Lingotes</title>
    <!-- Fontes Principais -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Fonte para Código de Barras -->
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+128&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --display-bg: #0f172a;
            --display-text: #38bdf8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- Toast Notifications --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 11000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease-out forwards;
            border-left: 5px solid var(--primary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.info { border-left-color: var(--primary); }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }

        /* --- Sidebar --- */
        .sidebar {
            width: 80px;
            background-color: var(--display-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            transition: width 0.3s;
            z-index: 10;
        }
        
        .sidebar:hover { width: 200px; }

        .logo-area {
            width: 60px; height: 60px; border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 40px; overflow: hidden; background: white; padding: 5px;
        }
        
        .logo-area img { width: 100%; height: 100%; object-fit: contain; }

        .nav-item {
            width: 100%; display: flex; align-items: center;
            padding: 15px 0; cursor: pointer; color: #94a3b8;
            transition: 0.2s; text-decoration: none;
        }

        .nav-item:hover, .nav-item.active {
            background-color: rgba(255,255,255,0.1); color: white; border-left: 4px solid var(--primary);
        }

        .nav-icon { width: 80px; text-align: center; font-size: 1.2rem; }
        .nav-text { white-space: nowrap; opacity: 0; transition: opacity 0.2s; }
        .sidebar:hover .nav-text { opacity: 1; }

        /* --- Main Content --- */
        .main-content {
            flex: 1; padding: 20px;
            display: grid; grid-template-columns: 350px 1fr;
            grid-template-rows: auto 1fr; gap: 20px; height: 100vh;
        }

        header {
            grid-column: 1 / -1; display: flex; justify-content: space-between;
            align-items: center; background: var(--bg-card);
            padding: 10px 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .status-badge {
            display: flex; align-items: center; gap: 8px; padding: 6px 12px;
            border-radius: 20px; font-size: 0.85rem; font-weight: 600;
            background: #dcfce7; color: var(--success);
        }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; box-shadow: 0 0 5px currentColor; }

        .header-center { font-size: 1.2rem; font-weight: 600; display: flex; gap: 10px; align-items: center; }
        .clock-display { background: #f1f5f9; padding: 5px 15px; border-radius: 8px; font-family: 'Courier New', monospace; color: var(--primary); }

        .user-info { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .user-avatar { width: 35px; height: 35px; background: var(--secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; }

        /* --- Cards --- */
        .card {
            background: var(--bg-card); border-radius: 16px; padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; overflow: hidden;
        }

        .card-title {
            font-size: 1rem; font-weight: 600; margin-bottom: 15px; color: var(--secondary);
            display: flex; align-items: center; justify-content: space-between; gap: 8px; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px;
        }

        .form-section { display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }

        .input-group { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 0.75rem; font-weight: 700; color: var(--secondary); text-transform: uppercase; }

        input, select {
            padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px;
            font-size: 0.95rem; outline: none; background: #f8fafc; width: 100%;
        }

        input:focus, select:focus { border-color: var(--primary); background: white; }
        input:read-only, select:disabled, input:disabled { background-color: #e2e8f0; cursor: not-allowed; color: #64748b; }

        /* --- Scale Section --- */
        .display-container {
            background: var(--display-bg); color: var(--display-text); padding: 20px 30px;
            border-radius: 16px; text-align: right; position: relative; box-shadow: inset 0 0 30px rgba(0,0,0,0.6);
            display: flex; flex-direction: column; justify-content: center; height: 120px; flex-shrink: 0;
        }

        .weight-value { font-family: 'Courier New', monospace; font-size: 3.5rem; font-weight: 700; text-shadow: 0 0 15px rgba(56, 189, 248, 0.4); }

        .weight-controls { display: grid; grid-template-columns: 0.8fr 1fr 1fr 1fr; gap: 15px; flex-shrink: 0; }
        .weight-input-card { background: #f8fafc; padding: 10px 15px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .weight-input-card input { font-size: 1.4rem; font-weight: 700; border: none; background: transparent !important; border-bottom: 2px solid #cbd5e1; width: 100%; text-align: right; border-radius: 0; padding: 0;}
        .highlight { background: #ecfdf5; border-color: #a7f3d0; }
        .highlight input { color: var(--success); border-color: var(--success); }

        .btn { padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 0.95rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: white; border: 1px solid #cbd5e1; color: var(--text-main); }

        .history-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; margin-top: 10px; background: white; border-radius: 12px; padding: 15px; border: 1px solid #e2e8f0; }
        .table-container { overflow-y: auto; flex: 1; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { text-align: left; padding: 12px; background: #f8fafc; color: var(--secondary); position: sticky; top: 0; font-weight: 700; }
        td { padding: 10px 12px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 400px; text-align: center; }
        
        .user-modal-box { background: white; padding: 30px; border-radius: 16px; width: 700px; max-height: 80vh; display: flex; flex-direction: column; gap: 20px; }

        .etiqueta-modal { background: white; width: 380px; display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.5); font-family: 'Courier New', monospace; }
        .relatorio-modal { background: white; width: 900px; max-height: 90vh; display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .relatorio-content { padding: 40px; overflow-y: auto; font-family: Arial, sans-serif; color: black; }

        .hidden { display: none !important; }

        /* Estilo Tarugo */
        #camposTarugo { display: flex; flex-direction: column; gap: 12px; border-top: 1px dashed #e2e8f0; padding-top: 12px; margin-top: 5px; }

        .relatorio-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 15px; }
        .relatorio-info { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; font-size: 14px; border: 1px solid #ccc; padding: 15px; background: #f9f9f9; }
        .relatorio-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        .relatorio-table th { background: #eee; font-weight: bold; border-bottom: 2px solid #000; padding: 10px; text-align: left; }
        .relatorio-table td { padding: 8px 10px; border-bottom: 1px solid #f0f0f0; }

        @media print {
            body * { visibility: hidden; }
            .printing-label #etiquetaModal, .printing-label #etiquetaModal * { visibility: visible; }
            .printing-label #etiquetaModal { position: absolute; left: 0; top: 0; width: 100%; display: block !important; border: none; box-shadow: none; }
            .printing-report #relatorioModal, .printing-report #relatorioModal * { visibility: visible; }
            .printing-report #relatorioModal { position: absolute; left: 0; top: 0; width: 100%; display: block !important; border: none; box-shadow: none; }
            .btn, .etiqueta-controls, .relatorio-footer, .sidebar, header { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <!-- LOGIN -->
    <div id="loginModal" class="modal-overlay">
        <div class="login-box">
            <div style="margin-bottom: 20px;"><img src="photos/logo-mp.png" alt="Logo" style="max-height: 100px;" onerror="this.style.display='none'"></div>
            <h2 style="margin-bottom: 10px;">Sistema de Identificação</h2>
            <p style="color: var(--secondary); margin-bottom: 25px;">Acesso ao Sistema</p>
            <form id="loginForm" style="display: flex; flex-direction: column; gap: 10px;">
                <select id="username" required><option value="">Selecione um usuário...</option></select>
                <input type="password" id="password" placeholder="Senha" required>
                <button type="submit" class="btn btn-primary">Entrar</button>
            </form>
            <p id="loginError" style="color: var(--danger); font-size: 0.8rem; margin-top: 10px;" class="hidden">Senha incorreta.</p>
        </div>
    </div>

    <!-- GERENCIAMENTO DE USUÁRIOS -->
    <div id="userModal" class="modal-overlay hidden">
        <div class="user-modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3><i class="fa-solid fa-users-gear"></i> Gerenciar Usuários</h3>
                <button class="btn-secondary" style="padding:5px 10px;" onclick="closeUserModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                <div class="input-group"><label>Usuário</label><input type="text" id="newUsername" placeholder="Nome"></div>
                <div class="input-group"><label>Senha</label><input type="password" id="newPassword" placeholder="Senha"></div>
                <div class="input-group" style="grid-column: span 2;"><button class="btn btn-primary" onclick="createNewUser()">Criar Usuário</button></div>
            </div>
            <div class="table-container" style="max-height: 300px;"><table id="usersTable"><thead><tr><th>Usuário</th><th>Cargo</th><th>Ações</th></tr></thead><tbody></tbody></table></div>
        </div>
    </div>

    <!-- ETIQUETA MODAL -->
    <div id="etiquetaModal" class="etiqueta-modal">
        <div id="etiquetaArea" style="padding: 15px; background: white;"></div>
        <div class="etiqueta-controls" style="padding: 10px; border-top: 1px solid #eee; text-align: center;">
            <button class="btn btn-primary" onclick="window.print()" style="width: 100%; margin-bottom: 5px;"><i class="fa-solid fa-print"></i> Imprimir</button>
            <button class="btn btn-secondary" onclick="fecharEtiqueta()" style="width: 100%;">Fechar</button>
        </div>
    </div>

    <!-- RELATÓRIO MODAL -->
    <div id="relatorioModal" class="relatorio-modal">
        <div id="relatorioConteudo" class="relatorio-content"></div>
        <div class="relatorio-footer" style="padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; background: white;">
            <button class="btn btn-primary" onclick="imprimirRelatorio()" style="flex:1">Imprimir Relatório</button>
            <button class="btn btn-secondary" onclick="fecharRelatorio()" style="flex:1">Fechar</button>
        </div>
    </div>

    <nav class="sidebar">
        <div class="logo-area"><img src="photos/logo-latem.png" alt="Logo" onerror="this.style.display='none'"></div>
        <a href="#" class="nav-item active">
            <div class="nav-icon"><i class="fa-solid fa-tags"></i></div>
            <span class="nav-text">Identificação</span>
        </a>
        <a href="#" class="nav-item" onclick="openUserModal()">
            <div class="nav-icon"><i class="fa-solid fa-users"></i></div>
            <span class="nav-text">Usuários</span>
        </a>
        <div style="margin-top: auto; width: 100%; margin-bottom: 20px;">
            <a href="#" class="nav-item" onclick="logout()">
                <div class="nav-icon"><i class="fa-solid fa-right-from-bracket"></i></div>
                <span class="nav-text">Sair</span>
            </a>
        </div>
    </nav>

    <main class="main-content">
        <header>
            <div class="status-badge"><div class="status-dot"></div><span>Conectado</span></div>
            <div class="header-center"><i class="fa-regular fa-clock"></i><div class="clock-display" id="clock">00:00:00</div></div>
            <div class="user-info"><span id="userNameDisplay">---</span><div class="user-avatar"><i class="fa-solid fa-user"></i></div></div>
        </header>

        <div class="card form-section">
            <div class="card-title">
                <span><i class="fa-solid fa-industry"></i> Dados da Produção</span>
                <span id="statusLote" style="font-size: 0.8rem; background: var(--warning); color: white; padding: 3px 8px; border-radius: 10px; display: none;">Campos Bloqueados</span>
            </div>
            
            <div class="input-group">
                <label>Liga</label>
                <input type="text" id="liga" placeholder="Ex: SAE 306, AA 6060">
            </div>

            <div class="input-group">
                <label>Lote + Fornada</label>
                <input type="text" id="loteFornada" placeholder="Ex: 000.0+000">
            </div>

            <div class="input-group">
                <label>Tipo de Produto</label>
                <select id="tipo" onchange="toggleCamposTarugo()">
                    <option value="Lingote">Lingote</option>
                    <option value="Tarugo">Tarugo</option>
                </select>
            </div>

            <div id="camposTarugo" class="hidden">
                <div class="input-group"><label>Forno Homogenização</label><input type="text" id="forno" placeholder="Ex: 12T, 30T"></div>
                <div class="input-group"><label>Polegada</label><input type="number" step="0.1" id="polegada" placeholder="Ex: 4, 5" oninput="calcularPesos()"></div>
                <div class="input-group"><label>Comprimento (m)</label><input type="number" step="0.01" id="comprimento" placeholder="0.00" oninput="calcularPesos()"></div>
            </div>
            
            <button class="btn btn-secondary" onclick="limparTudo()" style="margin-top: auto;"><i class="fa-solid fa-eraser"></i> Limpar Tudo / Novo Lote</button>
        </div>

        <div class="scale-section" style="display: flex; flex-direction: column; gap: 15px;">
            <div class="display-container">
                <div style="position:absolute; top:15px; left:20px; font-size:0.8rem; color:#64748b;">PESO LÍQUIDO</div>
                <div class="weight-value" id="displayLiquido">0</div>
                <div style="position:absolute; bottom:20px; right:30px; font-size:1.5rem; color:#64748b;">KG</div>
            </div>

            <div class="weight-controls">
                <div class="weight-input-card" style="background: #fff7ed;"><label>Qtd (Peças)</label><input type="number" id="quantidade" value="0"></div>
                <div class="weight-input-card">
                    <label ondblclick="simularPesoBalança()" style="cursor: help;" title="Duplo clique para simular pesagem (Para testes)">Bruto (kg) <i class="fa-solid fa-link" style="font-size: 0.6rem;"></i></label>
                    <input type="number" id="pesoBruto" readonly>
                </div>
                <div class="weight-input-card"><label>Tara (kg)</label><input type="number" id="pesoTara" oninput="calcularPesos()"></div>
                <div class="weight-input-card highlight"><label>Líquido (kg)</label><input type="number" id="pesoLiquido" readonly></div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button class="btn btn-primary" onclick="registrarProducao()"><i class="fa-solid fa-check-double"></i> Identificar</button>
                <button class="btn btn-warning" onclick="gerarRelatorio()"><i class="fa-solid fa-print"></i> Relatório</button>
            </div>

            <div class="history-section">
                <div class="card-title"><span><i class="fa-solid fa-list-check"></i> Registros Recentes</span></div>
                <div class="table-container">
                    <table id="historyTable">
                        <thead>
                            <!-- Cabeçalho gerado dinamicamente via JS -->
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- RELÓGIO ---
        function updateClock() { document.getElementById('clock').innerText = new Date().toLocaleTimeString('pt-BR'); }
        setInterval(updateClock, 1000);

        // --- USUÁRIOS ---
        const DEFAULT_USERS = [{ user: 'admin', pass: 'admin', role: 'admin' }, { user: 'operador', pass: '1234', role: 'user' }];
        function getUsers() { return JSON.parse(localStorage.getItem('latem_prod_users')) || DEFAULT_USERS; }
        function saveUsers(users) { localStorage.setItem('latem_prod_users', JSON.stringify(users)); }

        function renderUserSelect() {
            const select = document.getElementById('username');
            select.innerHTML = '<option value="">Selecione um usuário...</option>';
            getUsers().forEach(u => select.innerHTML += `<option value="${u.user}">${u.user}</option>`);
        }

        function openUserModal() {
            const currentUser = localStorage.getItem('prod_user');
            if (getUsers().find(u => u.user === currentUser)?.role === 'admin') {
                document.getElementById('userModal').classList.remove('hidden'); renderUsersTable();
            } else { showToast("Acesso negado. Apenas administradores.", 'error'); }
        }
        function closeUserModal() { document.getElementById('userModal').classList.add('hidden'); }

        function renderUsersTable() {
            const tbody = document.querySelector('#usersTable tbody'); tbody.innerHTML = '';
            getUsers().forEach(u => {
                const tr = document.createElement('tr');
                let btns = `<button class="btn" style="color:var(--warning)" onclick="changePassword('${u.user}')"><i class="fa-solid fa-key"></i></button>`;
                if (u.user !== localStorage.getItem('prod_user')) btns += `<button class="btn" style="color:var(--danger)" onclick="deleteUser('${u.user}')"><i class="fa-solid fa-trash"></i></button>`;
                tr.innerHTML = `<td>${u.user}</td><td>${u.role==='admin'?'Admin':'Operador'}</td><td>${btns}</td>`;
                tbody.appendChild(tr);
            });
        }

        function createNewUser() {
            const u = document.getElementById('newUsername').value, p = document.getElementById('newPassword').value;
            if(!u || !p) return showToast("Preencha tudo.", 'warning');
            const users = getUsers(); if(users.find(x => x.user === u)) return showToast("Já existe.", 'error');
            users.push({user: u, pass: p, role: 'user'}); saveUsers(users); renderUsersTable(); renderUserSelect();
            showToast("Usuário criado!");
        }

        function deleteUser(u) { if(confirm(`Excluir ${u}?`)) { saveUsers(getUsers().filter(x => x.user !== u)); renderUsersTable(); renderUserSelect(); } }
        function changePassword(u) { const p = prompt(`Nova senha para ${u}:`); if(p) { const us = getUsers(); us.find(x => x.user === u).pass = p; saveUsers(us); showToast("Senha alterada."); } }

        // --- LOGIN ---
        function initLogin() {
            renderUserSelect();
            if(localStorage.getItem('prod_user')) {
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('userNameDisplay').innerText = localStorage.getItem('prod_user');
            }
        }
        document.getElementById('loginForm').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value, p = document.getElementById('password').value;
            const found = getUsers().find(x => x.user === u && x.pass === p);
            if(found) {
                localStorage.setItem('prod_user', found.user);
                document.getElementById('loginModal').classList.add('hidden');
                document.getElementById('userNameDisplay').innerText = found.user;
                showToast("Login realizado!", "success");
            } else { document.getElementById('loginError').classList.remove('hidden'); }
        };
        function logout() { 
            showToast("Sessão encerrada com sucesso.", "info");
            setTimeout(() => { localStorage.removeItem('prod_user'); location.reload(); }, 1000);
        }

        // --- LÓGICA DE PRODUÇÃO E BLOQUEIOS ---
        function toggleCamposTarugo() { 
            const isTarugo = document.getElementById('tipo').value === 'Tarugo';
            document.getElementById('camposTarugo').classList.toggle('hidden', !isTarugo); 
            
            const inputQtd = document.getElementById('quantidade');
            if(isTarugo) {
                inputQtd.value = ''; 
                inputQtd.readOnly = true; 
            } else {
                inputQtd.readOnly = false; 
            }
            calcularPesos();
        }

        function simularPesoBalança() {
            let p = prompt("SIMULAÇÃO DE TESTE:\nDigite um peso simulado vindo do Indicador 3104C (Ex: 1500.5):");
            if(p && !isNaN(p.replace(',','.'))) {
                document.getElementById('pesoBruto').value = p.replace(',','.');
                calcularPesos();
            }
        }

        function calcularPesos() {
            const b = parseFloat(document.getElementById('pesoBruto').value) || 0;
            const t = parseFloat(document.getElementById('pesoTara').value) || 0;
            const l = Math.max(0, b - t); 
            
            document.getElementById('pesoLiquido').value = l > 0 ? l.toFixed(1) : ''; 
            document.getElementById('displayLiquido').innerText = l > 0 ? l.toFixed(1) : '0';

            if (document.getElementById('tipo').value === 'Tarugo') {
                const pol = parseFloat(document.getElementById('polegada').value) || 0;
                const comp = parseFloat(document.getElementById('comprimento').value) || 0;
                
                if (l > 0 && pol > 0 && comp > 0) {
                    let qtdCalculada = Math.round(l / (pol * comp * 2.7)); 
                    document.getElementById('quantidade').value = Math.max(1, qtdCalculada); 
                } else {
                    document.getElementById('quantidade').value = '';
                }
            }
        }

        function bloquearCamposLote() {
            const isTarugo = document.getElementById('tipo').value === 'Tarugo';
            const camposParaBloquear = ['liga', 'loteFornada', 'tipo'];
            if(isTarugo) camposParaBloquear.push('forno', 'polegada', 'comprimento');

            camposParaBloquear.forEach(id => {
                const el = document.getElementById(id);
                el.disabled = true; 
            });
            document.getElementById('statusLote').style.display = 'inline-block';
        }

        function destravarCamposLote() {
            ['liga', 'loteFornada', 'tipo', 'forno', 'polegada', 'comprimento'].forEach(id => {
                document.getElementById(id).disabled = false;
            });
            document.getElementById('statusLote').style.display = 'none';
        }

        function showToast(msg, type='success') {
            const c = document.getElementById('toast-container'), t = document.createElement('div');
            t.className = `toast ${type}`;
            const icon = type === 'error' ? 'circle-exclamation' : (type === 'info' ? 'circle-info' : 'circle-check');
            t.innerHTML = `<i class="fa-solid fa-${icon}"></i> <span>${msg}</span>`;
            c.appendChild(t); setTimeout(() => { t.style.animation = 'fadeOut 0.5s forwards'; setTimeout(()=>t.remove(), 500); }, 3000);
        }

        function getDb() { return JSON.parse(localStorage.getItem('latem_prod_db')) || []; }
        function saveDb(db) { localStorage.setItem('latem_prod_db', JSON.stringify(db)); renderHistory(); }

        function registrarProducao() {
            const lote = document.getElementById('loteFornada').value, 
                  liga = document.getElementById('liga').value, 
                  tipo = document.getElementById('tipo').value, 
                  qtd = document.getElementById('quantidade').value, 
                  b = document.getElementById('pesoBruto').value, 
                  t = document.getElementById('pesoTara').value || 0, 
                  l = document.getElementById('pesoLiquido').value;
            
            if(!lote || !liga || !b || qtd <= 0 || !qtd) return showToast("Preencha campos obrigatórios e garanta que haja peso/qtd", "warning");
            
            const item = {
                id: Date.now(), data: new Date().toLocaleDateString('pt-BR'), hora: new Date().toLocaleTimeString('pt-BR'), lote, liga, tipo, qtd, bruto: b, tara: t, liq: l,
                forno: tipo === 'Tarugo' ? document.getElementById('forno').value : '', 
                polegada: tipo === 'Tarugo' ? document.getElementById('polegada').value : '', 
                comprimento: tipo === 'Tarugo' ? document.getElementById('comprimento').value : '',
                responsavel: localStorage.getItem('prod_user')
            };
            
            const db = getDb(); db.unshift(item); saveDb(db);
            showToast("Identificado com sucesso!");
            gerarEtiqueta(item);
            
            bloquearCamposLote();
            
            document.getElementById('pesoBruto').value = '';
            document.getElementById('pesoTara').value = '';
            document.getElementById('pesoLiquido').value = '';
            document.getElementById('displayLiquido').innerText = '0';
            
            if (tipo === 'Lingote') {
                document.getElementById('quantidade').value = '0';
            } else {
                document.getElementById('quantidade').value = '';
            }
        }

        function renderHistory() {
            const db = getDb();
            const thead = document.querySelector('#historyTable thead');
            const tbody = document.querySelector('#historyTable tbody'); 
            tbody.innerHTML = '';
            
            // Define o cabeçalho fixo (apenas informações de contagem e peso)
            let headerHTML = `<tr>
                <th>Nº</th>
                <th>Qtd</th>
                <th>Líquido</th>
                <th>Tara</th>
                <th>Bruto</th>
                <th>Ações</th>
            </tr>`;
            thead.innerHTML = headerHTML;

            if (!db.length) {
                return; // Se estiver vazio, já renderizou o header
            }

            // Linhas Dinâmicas apenas com dados de pesagem
            db.slice(0, 15).forEach((i, index) => {
                const contador = db.length - index;

                let rowHTML = `<tr>
                    <td>${contador}</td>
                    <td style="font-weight:bold">${i.qtd}</td>
                    <td style="font-weight:bold">${i.liq}</td>
                    <td>${i.tara}</td>
                    <td>${i.bruto}</td>
                    <td><button class="btn" style="color:var(--danger); padding: 5px; height: auto;" onclick="removerItem(${i.id})"><i class="fa-solid fa-trash"></i></button></td>
                </tr>`;

                tbody.innerHTML += rowHTML;
            });
        }
        
        function removerItem(id) { if(confirm("Excluir registro?")) saveDb(getDb().filter(i => i.id !== id)); }
        
        function limparTudo() { 
            destravarCamposLote();
            ['loteFornada', 'liga', 'forno', 'polegada', 'comprimento', 'pesoBruto', 'pesoTara', 'pesoLiquido'].forEach(id => { 
                const el = document.getElementById(id); 
                if(el) el.value = ''; 
            }); 
            document.getElementById('tipo').value = 'Lingote';
            document.getElementById('quantidade').value = '0';
            document.getElementById('displayLiquido').innerText = '0'; 
            toggleCamposTarugo();
            renderHistory();
        }

        // --- ETIQUETA ---
        function gerarEtiqueta(item) {
            document.getElementById('etiquetaArea').innerHTML = `
                <div style="text-align: center; border-bottom: 2px solid black; padding-bottom: 5px; margin-bottom: 10px;">
                    <img src="photos/logo-latem.png" style="max-height: 40px; margin-bottom: 5px;" onerror="this.style.display='none'">
                    <div style="font-weight: bold; font-size: 13px;">IDENTIFICAÇÃO DE PRODUTO</div>
                </div>
                <div style="font-size: 11px; line-height: 1.4; display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="text-align: left;">
                        <div><strong>LIGA:</strong> ${item.liga}</div>
                        <div><strong>LOTE/FORNADA:</strong> ${item.lote}</div>
                        <div><strong>TIPO:</strong> ${item.tipo.toUpperCase()}</div>
                    </div>
                    ${item.tipo === 'Tarugo' ? `
                        <div style="text-align: right;">
                            <div><strong>FORNO:</strong> ${item.forno}</div>
                            <div><strong>POL:</strong> ${item.polegada}</div>
                            <div><strong>COMP:</strong> ${item.comprimento}m</div>
                        </div>
                    ` : ''}
                </div>
                <div style="font-size: 11px; line-height: 1.4; margin-top: 5px; border-top: 1px dashed #000; padding-top: 5px;">
                    <div style="display:flex; justify-content:space-between"><span>BRUTO: ${item.bruto}KG</span><span>TARA: ${item.tara}KG</span></div>
                    <div style="font-size: 18px; font-weight: bold; text-align: center; margin: 5px 0;">LÍQUIDO: ${item.liq} KG</div>
                    <div style="font-size: 16px; font-weight: bold; text-align: center;">QTD: ${item.qtd} PEÇAS</div>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <div style="font-family: 'Libre Barcode 128', cursive; font-size: 45px;">*${item.lote}*</div>
                    <div style="font-size: 9px;">${item.data} ${item.hora} - ${item.responsavel.toUpperCase()}</div>
                </div>`;
            document.getElementById('etiquetaModal').style.display = 'flex';
        }
        function fecharEtiqueta() { document.getElementById('etiquetaModal').style.display = 'none'; }

        // --- RELATÓRIO ---
        function gerarRelatorio() {
            const db = getDb(); if(!db.length) return showToast("Sem dados para gerar relatório.", "warning");
            
            let rows = '', tb = 0, tt = 0, tl = 0;
            const isTarugo = db[0].tipo === 'Tarugo';
            
            // Inverte para imprimir na ordem natural da produção (do 1 ao N)
            const dbImpressao = db.slice().reverse();

            dbImpressao.forEach((i, index) => {
                tb += parseFloat(i.bruto); tt += parseFloat(i.tara); tl += parseFloat(i.liq);
                const contador = index + 1; // Contador Sequencial
                
                rows += `<tr>
                    <td style="text-align: center;">${contador}</td>
                    <td style="text-align: center;">${i.qtd}</td>
                    <td style="text-align: right; font-weight: bold;">${i.liq}</td>
                    <td style="text-align: right;">${i.tara}</td>
                    <td style="text-align: right;">${i.bruto}</td>
                </tr>`;
            });

            document.getElementById('relatorioConteudo').innerHTML = `
                <div class="relatorio-header">
                    <img src="photos/logo-latem.png" style="max-height: 60px; margin-bottom: 10px;" onerror="this.style.display='none'">
                    <h2>Relatório de Produção</h2>
                </div>
                
                <!-- Primeiro Bloco de Informações -->
                <div class="relatorio-info">
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <div><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</div>
                        <div><strong>Hora:</strong> ${new Date().toLocaleTimeString('pt-BR')}</div>
                        <div><strong>Responsável:</strong> ${localStorage.getItem('prod_user').toUpperCase()}</div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:5px; text-align: right;">
                        <div><strong>Peso Bruto Total:</strong> ${tb.toFixed(2)} kg</div>
                        <div><strong>Tara Total:</strong> ${tt.toFixed(2)} kg</div>
                        <div><strong>Peso Líquido Total:</strong> ${tl.toFixed(2)} kg</div>
                    </div>
                </div>

                <!-- Segundo Bloco de Informações (Liga, Lote, Tipo e Atributos de Tarugo se for o caso) -->
                <div class="relatorio-info">
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <div><strong>Liga:</strong> ${db[0].liga}</div>
                        <div><strong>Lote + Fornada:</strong> ${db[0].lote}</div>
                        <div><strong>Tipo:</strong> ${db[0].tipo.toUpperCase()}</div>
                    </div>
                    ${isTarugo ? `
                    <div style="display:flex; flex-direction:column; gap:5px; text-align: right;">
                        <div><strong>Forno:</strong> ${db[0].forno}</div>
                        <div><strong>Polegada:</strong> ${db[0].polegada}"</div>
                        <div><strong>Comprimento:</strong> ${db[0].comprimento}m</div>
                    </div>
                    ` : '<div></div>'}
                </div>

                <!-- Tabela de Materiais (Itens) -->
                <table class="relatorio-table">
                    <thead>
                        <tr>
                            <th style="text-align: center; width: 10%;">Nº</th>
                            <th style="text-align: center; width: 15%;">Qtd (Peças)</th>
                            <th style="text-align: right; width: 25%;">Líquido (kg)</th>
                            <th style="text-align: right; width: 25%;">Tara (kg)</th>
                            <th style="text-align: right; width: 25%;">Bruto (kg)</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>`;
            
            document.getElementById('relatorioModal').style.display = 'flex';
        }
        function fecharRelatorio() { document.getElementById('relatorioModal').style.display = 'none'; }
        
        function imprimirRelatorio() {
            const now = new Date();
            const dataRel = now.toLocaleDateString('pt-BR').replace(/\//g, '-');
            const horaRel = now.toLocaleTimeString('pt-BR').replace(/:/g, '-');
            const originalTitle = document.title;
            
            document.title = `RITL_${dataRel}_${horaRel}`;
            document.body.classList.add('printing-report'); 
            window.print(); 
            document.body.classList.remove('printing-report');
            document.title = originalTitle;
            
            localStorage.removeItem('latem_prod_db'); 
            renderHistory(); 
            limparTudo(); 
            fecharRelatorio();
            showToast("Relatório impresso e dados da seção atual apagados.");
        }

        window.onload = () => { initLogin(); renderHistory(); };
        window.onbeforeprint = () => { if(document.getElementById('etiquetaModal').style.display === 'flex') document.body.classList.add('printing-label'); };
        window.onafterprint = () => { document.body.classList.remove('printing-label'); };
    </script>
</body>
</html>