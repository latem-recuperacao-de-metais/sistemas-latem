<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Identificação</title>
    <!-- Fontes Principais -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Fonte para Código de Barras -->
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+128&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --display-bg: #0f172a;
            --display-text: #38bdf8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- Toast Notifications --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 11000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease-out forwards;
            border-left: 5px solid var(--primary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.info { border-left-color: var(--primary); }

        .toast i { font-size: 1.2rem; }
        .toast.success i { color: var(--success); }
        .toast.error i { color: var(--danger); }
        .toast.warning i { color: var(--warning); }
        .toast.info i { color: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 80px;
            background-color: var(--display-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            transition: width 0.3s;
            z-index: 10;
        }
        
        .sidebar:hover {
            width: 200px;
        }

        .logo-area {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
            overflow: hidden;
            background: white;
            padding: 5px;
        }
        
        .logo-area img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .nav-item {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 15px 0;
            cursor: pointer;
            color: #94a3b8;
            transition: 0.2s;
            text-decoration: none;
        }

        .nav-item:hover, .nav-item.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border-left: 4px solid var(--primary);
        }

        .nav-icon {
            width: 80px;
            text-align: center;
            font-size: 1.2rem;
        }

        .nav-text {
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .sidebar:hover .nav-text {
            opacity: 1;
        }

        /* --- Main Content --- */
        .main-content {
            flex: 1;
            padding: 20px;
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: auto 1fr;
            gap: 20px;
            height: 100vh;
        }

        header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            padding: 10px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* Header Components */
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* STATUS BADGE (Estilo "Conectado") */
        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #fee2e2;
            color: var(--danger);
            cursor: default;
            transition: 0.2s;
            border: 1px solid transparent;
        }

        .status-badge.connected {
            background: #dcfce7;
            color: var(--success);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            box-shadow: 0 0 5px currentColor;
        }

        .header-center {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .clock-display {
            background: #f1f5f9;
            padding: 5px 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: var(--primary);
        }

        .user-info { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .user-avatar { width: 35px; height: 35px; background: var(--secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; }

        /* --- Cards --- */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 10px;
        }

        /* --- Form Section (Left) --- */
        .form-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            position: relative;
        }

        label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            outline: none;
            transition: 0.2s;
            background: #f8fafc;
            width: 100%;
        }

        /* Estilo para campos bloqueados */
        input:read-only, select:disabled {
            background-color: #e2e8f0;
            color: #64748b;
            cursor: not-allowed;
            border-color: #cbd5e1;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* --- Scale Display (Right) --- */
        .scale-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: hidden;
        }

        .display-container {
            background: var(--display-bg);
            color: var(--display-text);
            padding: 20px 30px;
            border-radius: 16px;
            text-align: right;
            position: relative;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 120px; /* Reduzido um pouco pois não é o foco principal */
            flex-shrink: 0;
        }

        .display-label {
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .weight-value {
            font-family: 'Courier New', monospace;
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: -2px;
            line-height: 1;
            text-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
        }

        .unit {
            font-size: 1.5rem;
            color: #64748b;
            position: absolute;
            bottom: 20px;
            right: 30px;
        }
        
        /* --- Weight Controls --- */
        .weight-controls {
            display: grid;
            grid-template-columns: 0.8fr 1fr 1fr 1fr; /* Adicionado espaço para qtd */
            gap: 15px;
            flex-shrink: 0;
        }

        .weight-input-card {
            background: #f8fafc;
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .weight-input-card label { margin-bottom: 5px; display: block; }

        .weight-input-card input {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-main);
            text-align: right;
            border: none;
            background: transparent;
            border-bottom: 2px solid #cbd5e1;
            border-radius: 0;
            padding: 5px 0;
        }

        /* Estilo específico para input editável de peso */
        .weight-input-card input:not([readonly]) {
            border-bottom: 2px solid var(--primary);
            background-color: rgba(255,255,255,0.5);
        }
        
        .weight-input-card.highlight {
            background: #ecfdf5;
            border-color: #a7f3d0;
        }
        .weight-input-card.highlight input {
            color: var(--success);
            border-color: var(--success);
        }
        
        .qtd-card {
            background: #fff7ed;
            border-color: #fed7aa;
        }
        .qtd-card input {
            color: #c2410c;
            border-color: #f97316;
            text-align: center;
        }

        /* --- Action Buttons --- */
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            flex-shrink: 0;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        
        .btn-secondary { background: white; border: 1px solid #cbd5e1; color: var(--text-main); }
        .btn-secondary:hover { background: #f1f5f9; }

        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { filter: brightness(0.9); }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #b91c1c; }

        /* --- History Table --- */
        .history-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-top: 10px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .table-container {
            overflow-y: auto;
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th {
            text-align: left;
            padding: 12px;
            background: #f8fafc;
            color: var(--secondary);
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        tr:hover { background: #f1f5f9; }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            width: 400px;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Modal Etiqueta - Ajustado para múltiplas etiquetas */
        .etiqueta-modal {
            background: white;
            padding: 0;
            width: 380px;
            max-height: 90vh;
            border: 1px solid #ccc;
            font-family: 'Courier New', monospace;
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            flex-direction: column;
            overflow: hidden;
        }
        
        .etiqueta-scroll-area {
            overflow-y: auto;
            padding: 10px;
            background: #e2e8f0; /* Fundo cinza para destacar as folhas */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .etiqueta-individual {
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .etiqueta-controls {
            padding: 15px;
            background: white;
            border-top: 1px solid #eee;
            text-align: center;
        }
        
        /* Modal Relatório */
        .relatorio-modal {
            background: white;
            width: 800px;
            max-height: 90vh;
            border-radius: 8px;
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            overflow: hidden;
            flex-direction: column;
        }

        .relatorio-content {
            padding: 40px;
            overflow-y: auto;
            flex: 1;
            font-family: Arial, sans-serif;
            color: black;
        }

        .relatorio-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
        }

        .relatorio-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px; 
            margin-bottom: 20px;
            font-size: 14px;
            border: 1px solid #ccc;
            padding: 15px;
            background: #f9f9f9;
        }

        .relatorio-info div {
            margin-bottom: 5px;
        }
        
        .relatorio-info strong {
            display: inline-block;
            width: 100px; 
        }

        .relatorio-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }

        .relatorio-table th, .relatorio-table td {
            border: none;
            padding: 8px;
            text-align: left;
        }
        
        .relatorio-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
        }

        .relatorio-table th {
            background: #eee;
            font-weight: bold;
            border-bottom: 2px solid #000;
        }
        
        .user-modal-box {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .hidden { display: none !important; }

        @media (max-width: 1024px) {
            .main-content { grid-template-columns: 1fr; overflow-y: auto; }
            body { overflow: auto; }
            .sidebar { display: none; }
            .actions { grid-template-columns: 1fr; }
            .scale-section { overflow: visible; }
            .weight-controls { grid-template-columns: 1fr 1fr; }
        }

        /* --- PRINT STYLES --- */
        @media print {
            @page { margin: 2mm; }
            body { 
                background: white; 
                height: auto; 
                overflow: visible; 
                display: block; 
            }
            
            #toast-container { display: none !important; }
            .sidebar, .actions, .form-section, .weight-controls, .user-info, .btn, .scale-section, #userModal, #loginModal, .main-content, header {
                display: none !important;
            }

            /* --- MODO RELATÓRIO A4 --- */
            body.printing-report .relatorio-modal {
                display: block !important;
                position: relative !important;
                transform: none !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                max-height: none !important;
                box-shadow: none !important;
                border: none !important;
            }
            
            body.printing-report .relatorio-content {
                padding: 0;
                overflow: visible;
            }
            
            body.printing-report .relatorio-footer {
                display: none;
            }

            /* --- MODO ETIQUETA ZD220 --- */
            body.printing-label { 
                width: 100%; 
                margin: 0; 
                padding: 0;
            }
            body.printing-label .etiqueta-modal {
                display: block !important;
                position: static !important;
                transform: none !important;
                width: 100% !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
                background: none !important;
                max-height: none !important; /* Importante para não cortar */
            }
            
            body.printing-label .etiqueta-scroll-area {
                padding: 0 !important;
                background: white !important;
                overflow: visible !important;
                gap: 0 !important;
                display: block !important;
            }

            /* Ocultar cabeçalho do modal de etiquetas na impressão */
            body.printing-label .etiqueta-header-title {
                display: none !important;
            }

            body.printing-label .etiqueta-individual {
                box-shadow: none !important;
                border: none !important;
                break-after: page; /* Comando moderno para quebra de página */
                page-break-after: always; /* Fallback */
                margin-bottom: 0;
                padding: 0 !important;
                width: 100%;
                height: auto;
                display: block;
            }
            
            /* Remove margem da última etiqueta para não criar folha em branco extra */
            body.printing-label .etiqueta-individual:last-child {
                break-after: auto;
                page-break-after: auto;
            }

            body.printing-label .etiqueta-controls { display: none !important; }
        }
    </style>
</head>
<body>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="modal-overlay">
        <div class="login-box">
            <!-- Imagem substituindo o ícone de balança -->
            <div style="margin-bottom: 20px; display: flex; justify-content: center;">
                <img src="photos/logo-mp.png" alt="Logo MP" style="max-height: 100px; max-width: 100%;">
            </div>
            <h2 style="margin-bottom: 10px;">Sistema de Identificação</h2>
            <p style="color: var(--secondary); margin-bottom: 25px;">Acesso ao Sistema</p>
            
            <form id="loginForm" class="input-group">
                <!-- Dropdown de Usuários -->
                <select id="username" required>
                    <option value="">Selecione um usuário...</option>
                </select>
                <input type="password" id="password" placeholder="Senha" required style="margin-top: 10px;">
                <button type="submit" class="btn btn-primary" style="margin-top: 20px; width: 100%;">Entrar</button>
            </form>
            <p id="loginError" style="color: var(--danger); font-size: 0.8rem; margin-top: 10px;" class="hidden">Senha incorreta.</p>
        </div>
    </div>

    <!-- USER MANAGEMENT MODAL -->
    <div id="userModal" class="modal-overlay hidden">
        <div class="user-modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3><i class="fa-solid fa-users-gear"></i> Gerenciar Usuários</h3>
                <button class="btn-secondary" style="padding:5px 10px;" onclick="closeUserModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                <div class="input-group">
                    <label>Usuário</label>
                    <input type="text" id="newUsername" placeholder="Nome">
                </div>
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" id="newPassword" placeholder="Senha">
                </div>
                <div class="input-group" style="grid-column: span 2;">
                     <button class="btn btn-primary" onclick="createNewUser()">Criar Usuário</button>
                </div>
            </div>

            <div class="table-container" style="max-height: 300px;">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Usuário</th>
                            <th>Senha</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ETIQUETA MODAL (Preview e Impressão em Lote) -->
    <div id="etiquetaModal" class="etiqueta-modal">
        <!-- Classe adicionada para ocultar na impressão -->
        <div class="etiqueta-header-title" style="padding: 10px; background: #fff; border-bottom: 1px solid #ddd; font-weight: bold; text-align: center;">
            <i class="fa-solid fa-tags"></i> Visualização de Etiquetas
        </div>
        <div id="etiquetaScrollArea" class="etiqueta-scroll-area">
            <!-- Conteúdo dinâmico (várias etiquetas) -->
        </div>
        <div class="etiqueta-controls">
            <button class="btn btn-primary" onclick="imprimirEtiqueta()" style="width: 100%; margin-bottom: 5px;">
                <i class="fa-solid fa-print"></i> Imprimir Tudo
            </button>
            <button class="btn btn-secondary" onclick="fecharEtiqueta()" style="width: 100%;">Fechar</button>
        </div>
    </div>

    <!-- RELATÓRIO MODAL (Preview e Impressão) -->
    <div id="relatorioModal" class="relatorio-modal">
        <div id="relatorioConteudo" class="relatorio-content">
            <!-- Conteúdo dinâmico -->
        </div>
        <div class="relatorio-footer" style="padding: 15px; text-align: center; border-top: 1px solid #eee; background: #fff;">
            <button class="btn btn-primary" onclick="imprimirRelatorioReal()" style="width: 100%; margin-bottom: 5px;">Imprimir Relatório</button>
            <button class="btn btn-secondary" onclick="fecharRelatorio()" style="width: 100%;">Fechar</button>
        </div>
    </div>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="logo-area">
            <img src="photos/logo-latem.png" alt="Logo Latem">
        </div>
        
        <a href="#" class="nav-item active">
            <div class="nav-icon"><i class="fa-solid fa-box-open"></i></div>
            <span class="nav-text">Identificação</span>
        </a>

        <a href="#" class="nav-item" onclick="openUserModal()">
            <div class="nav-icon"><i class="fa-solid fa-users"></i></div>
            <span class="nav-text">Usuários</span>
        </a>

        <div style="margin-top: auto; width: 100%; margin-bottom: 20px;">
            <a href="#" class="nav-item" onclick="logout()">
                <div class="nav-icon"><i class="fa-solid fa-right-from-bracket"></i></div>
                <span class="nav-text">Sair</span>
            </a>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        
        <!-- Header -->
        <header>
            <div class="header-left">
                <!-- Status Badge estilo "Conectado" -->
                <div class="status-badge connected">
                    <div class="status-dot"></div>
                    <span>Conectado</span>
                </div>
            </div>

            <div class="header-center">
                <i class="fa-regular fa-clock" style="color: var(--primary);"></i>
                <div class="clock-display" id="clock">00:00:00</div>
                <div style="font-size: 0.9rem; color: var(--secondary);" id="date">01/01/2024</div>
            </div>

            <div class="user-info">
                <span id="userNameDisplay">Operador</span>
                <div class="user-avatar"><i class="fa-solid fa-user"></i></div>
            </div>
        </header>

        <!-- Coluna Esquerda: Formulário -->
        <div class="card form-section">
            <div class="card-title">
                <span><i class="fa-solid fa-file-invoice"></i> Dados do Lote</span>
            </div>
            
            <div class="input-group">
                <label>Nº Ticket / Lote</label>
                <input type="text" id="ticket" placeholder="00000">
            </div>

            <div class="input-group">
                <label>Nota Fiscal</label>
                <input type="text" id="nfe" placeholder="000.000.000">
            </div>

            <div class="input-group">
                <label>Fornecedor</label>
                <input type="text" id="fornecedor" placeholder="Ex: Castilho, Latem">
            </div>

            <div class="input-group">
                <label>Material</label>
                <input type="text" id="material" placeholder="Ex: Cavaco, Perfil">
            </div>

            <div class="input-group">
                <label>Localização</label>
                <input type="text" id="localizacao" placeholder="Ex: RB, Casinha de Borra">
            </div>

            <div class="input-group">
                <label>Unidade</label>
                <input type="text" id="unidade" placeholder="Ex: Bag, Pallet">
            </div>
            
            <div style="margin-top: auto; padding-top: 10px; text-align: center;">
                 <button class="btn btn-secondary" onclick="limparTudo()" style="width: 100%;">
                    <i class="fa-solid fa-eraser"></i> Limpar Tudo
                </button>
            </div>
        </div>

        <!-- Coluna Direita: Entradas Manuais e Ações -->
        <div class="scale-section">
            
            <!-- Display Principal (Agora reflete o input manual) -->
            <div id="displayContainer" class="display-container">
                <div class="display-label">PESO LÍQUIDO</div>
                <div class="weight-value" id="displayLiquido">0</div>
                <div class="unit">KG</div>
            </div>
            
            <!-- Inputs de Peso e Quantidade -->
            <div class="weight-controls">
                
                <div class="weight-input-card qtd-card">
                    <label>Qtd (Vol)</label>
                    <input type="number" id="quantidade" value="0" min="1">
                </div>

                <div class="weight-input-card">
                    <label>Peso Bruto (kg)</label>
                    <input type="number" id="pesoBruto" placeholder="0" oninput="calcularPesos()">
                </div>

                <div class="weight-input-card" style="border-left: 4px solid var(--primary);">
                    <label>Tara (kg)</label>
                    <input type="number" id="pesoTara" placeholder="0" oninput="calcularPesos()">
                </div>

                <div class="weight-input-card highlight">
                    <label>Líquido (kg)</label>
                    <input type="number" id="pesoLiquido" value="0" readonly>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="actions">
                <button class="btn btn-primary" onclick="realizarIdentificacao()">
                    <i class="fa-solid fa-check-double"></i> Identificar
                </button>
                <button class="btn btn-warning" onclick="gerarRelatorio()">
                    <i class="fa-solid fa-print"></i> Relatório
                </button>
            </div>

            <!-- HISTÓRICO -->
            <div class="history-section">
                <div class="card-title" style="margin-bottom: 10px;">
                    <i class="fa-solid fa-list-check"></i> Registros Recentes
                </div>
                <div class="table-container">
                    <table id="historyTable">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Local</th>
                                <th>Qtd</th>
                                <th>Bruto</th>
                                <th>Tara</th>
                                <th>Liq</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

        </div>

    </main>

    <script>
        // --- TOAST NOTIFICATIONS ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'check-circle';
            if(type === 'error') icon = 'circle-exclamation';
            if(type === 'warning') icon = 'triangle-exclamation';
            if(type === 'info') icon = 'circle-info';

            toast.innerHTML = `<i class="fa-solid fa-${icon}"></i> <span>${message}</span>`;
            
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease-out forwards';
                setTimeout(() => {
                    toast.remove();
                }, 500);
            }, 3000);
        }

        // --- RELÓGIO E DATA ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('pt-BR');
            document.getElementById('date').innerText = now.toLocaleDateString('pt-BR');
        }
        setInterval(updateClock, 1000);
        updateClock();

        
        // --- GERENCIAMENTO DE USUÁRIOS ---
        const DEFAULT_USERS = [
            { user: 'admin', pass: 'admin', role: 'admin' },
            { user: 'operador', pass: '1234', role: 'user' }
        ];

        function getUsers() { return JSON.parse(localStorage.getItem('latem_id_users')) || DEFAULT_USERS; }
        function saveUsers(users) { localStorage.setItem('latem_id_users', JSON.stringify(users)); }

        // Renderiza o select de usuários no login
        function renderUserSelect() {
            const users = getUsers();
            const select = document.getElementById('username');
            select.innerHTML = '<option value="">Selecione um usuário...</option>';
            users.forEach(u => {
                const option = document.createElement('option');
                option.value = u.user;
                option.textContent = u.user;
                select.appendChild(option);
            });
        }

        function openUserModal() {
            const currentUser = localStorage.getItem('latem_id_user');
            const users = getUsers();
            const userObj = users.find(u => u.user === currentUser);
            if (userObj && userObj.role === 'admin') {
                document.getElementById('userModal').classList.remove('hidden');
                renderUsersTable();
            } else {
                showToast("Acesso negado. Apenas administradores.", 'error');
            }
        }

        function closeUserModal() { document.getElementById('userModal').classList.add('hidden'); }

        function renderUsersTable() {
            const users = getUsers();
            const currentUser = localStorage.getItem('latem_id_user');
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            users.forEach(u => {
                const tr = document.createElement('tr');
                let buttons = '';
                if (u.user !== currentUser) buttons += `<button class="btn-danger" style="padding:5px 10px; margin-right:5px;" onclick="deleteUser('${u.user}')"><i class="fa-solid fa-trash"></i></button>`;
                buttons += `<button class="btn-warning" style="padding:5px 10px;" onclick="changePassword('${u.user}')"><i class="fa-solid fa-key"></i></button>`;
                tr.innerHTML = `<td>${u.user} ${u.role==='admin'?'<span style="font-size:0.7rem;background:#ddd;padding:2px 4px;border-radius:4px;">Admin</span>':''}</td><td>******</td><td>${buttons}</td>`;
                tbody.appendChild(tr);
            });
        }

        function createNewUser() {
            const newUser = document.getElementById('newUsername').value;
            const newPass = document.getElementById('newPassword').value;
            if(!newUser || !newPass) return showToast("Preencha usuário e senha.", 'warning');
            const users = getUsers();
            if(users.find(u => u.user === newUser)) return showToast("Usuário já existe.", 'error');
            users.push({ user: newUser, pass: newPass, role: 'user' });
            saveUsers(users);
            renderUsersTable();
            renderUserSelect();
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            showToast("Usuário criado com sucesso!");
        }

        function deleteUser(username) {
            if(confirm(`Excluir ${username}?`)) {
                let users = getUsers();
                users = users.filter(u => u.user !== username);
                saveUsers(users);
                renderUsersTable();
                renderUserSelect();
                showToast("Usuário excluído.");
            }
        }

        function changePassword(username) {
            const newPass = prompt(`Nova senha para ${username}:`);
            if(newPass) {
                let users = getUsers();
                const idx = users.findIndex(u => u.user === username);
                if(idx !== -1) { users[idx].pass = newPass; saveUsers(users); showToast("Senha alterada."); }
            }
        }

        // --- AUTENTICAÇÃO ---
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        
        // Init
        if(!localStorage.getItem('latem_id_users')) saveUsers(DEFAULT_USERS);
        renderUserSelect();

        if(localStorage.getItem('latem_id_user')) {
            loginModal.classList.add('hidden');
            document.getElementById('userNameDisplay').innerText = localStorage.getItem('latem_id_user');
        }
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const users = getUsers();
            const found = users.find(u => u.user === user && u.pass === pass);
            if (found) {
                localStorage.setItem('latem_id_user', found.user);
                loginModal.classList.add('hidden');
                document.getElementById('userNameDisplay').innerText = found.user;
                showToast("Login realizado com sucesso!", "success");
            } else { document.getElementById('loginError').classList.remove('hidden'); }
        });
        
        function logout() { 
            localStorage.removeItem('latem_id_user'); 
            showToast("Sessão encerrada com sucesso.", "info");
            setTimeout(() => {
                loginModal.classList.remove('hidden');
                document.getElementById('loginForm').reset();
                document.getElementById('loginError').classList.add('hidden');
            }, 1000);
        }

        // --- CÁLCULOS E VALIDAÇÕES ---

        function calcularPesos() {
            const bruto = parseFloat(document.getElementById('pesoBruto').value) || 0;
            const tara = parseFloat(document.getElementById('pesoTara').value) || 0;
            const liquido = bruto - tara;
            document.getElementById('pesoLiquido').value = liquido;
            const display = document.getElementById('displayLiquido');
            display.innerText = liquido; 
            if(liquido < 0) display.style.color = 'var(--danger)';
            else display.style.color = 'var(--display-text)';
        }

        // --- DATABASE ---
        function getDb() { return JSON.parse(localStorage.getItem('latem_db_id_v2')) || []; }
        function saveDb(data) { localStorage.setItem('latem_db_id_v2', JSON.stringify(data)); renderHistory(); }

        // --- BLOQUEIO DE CAMPOS DE SESSÃO ---
        function lockSessionFields() {
            document.getElementById('ticket').readOnly = true;
            document.getElementById('nfe').readOnly = true;
            document.getElementById('fornecedor').readOnly = true;
        }

        function unlockSessionFields() {
            document.getElementById('ticket').readOnly = false;
            document.getElementById('nfe').readOnly = false;
            document.getElementById('fornecedor').readOnly = false;
        }

        // --- IDENTIFICAR / PESAR EM LOTE ---
        function realizarIdentificacao() {
            const ticket = document.getElementById('ticket').value;
            const material = document.getElementById('material').value;
            const fornecedor = document.getElementById('fornecedor').value;
            const qtd = parseInt(document.getElementById('quantidade').value) || 0;
            const bruto = parseFloat(document.getElementById('pesoBruto').value) || 0;
            const tara = document.getElementById('pesoTara').value;
            const liquido = document.getElementById('pesoLiquido').value;
            
            if(!ticket) return showToast("O campo Ticket é obrigatório.", 'warning');
            if(!fornecedor) return showToast("O campo Fornecedor é obrigatório.", 'warning');
            if(!material) return showToast("O campo Material é obrigatório.", 'warning');
            if(bruto <= 0) return showToast("Peso bruto deve ser maior que zero.", 'warning');
            if(qtd < 1) return showToast("Quantidade inválida. Mínimo 1.", 'warning');

            const db = getDb();
            const dataHora = new Date();
            
            // AGORA CRIA UM ÚNICO REGISTRO PARA O LOTE INTEIRO
            const registro = {
                id: Date.now(), // ID único
                data: dataHora.toLocaleDateString('pt-BR'),
                hora: dataHora.toLocaleTimeString('pt-BR'),
                ticket,
                nfe: document.getElementById('nfe').value,
                fornecedor,
                local: document.getElementById('localizacao').value,
                material,
                unidade: document.getElementById('unidade').value, 
                bruto,
                tara: tara || 0,
                liquido,
                quantidade: qtd, // Armazena a quantidade total aqui
                responsavel: localStorage.getItem('latem_id_user')
            };
            
            db.unshift(registro);
            saveDb(db);
            lockSessionFields();
            showToast(`${qtd} Itens registrados com sucesso!`);
            
            // Passa o registro único para o gerador de etiquetas
            mostrarModalEtiquetaLote(registro);
            
            // Limpa parciais mas mantém Ticket/Fornecedor
            limparFormularioParcial();
        }

        function limparFormularioParcial() {
            document.getElementById('localizacao').value = '';
            document.getElementById('material').value = '';
            document.getElementById('unidade').value = '';
            document.getElementById('pesoBruto').value = '';
            // Mantém Tara se preenchida? Geralmente sim, mas aqui vamos manter simples
            // document.getElementById('pesoTara').value = ''; 
            document.getElementById('quantidade').value = '0';
            calcularPesos();
        }

        function limparTudo() {
            const ticket = document.getElementById('ticket').value;
            const nfe = document.getElementById('nfe').value;
            const fornecedor = document.getElementById('fornecedor').value;
            const localizacao = document.getElementById('localizacao').value;
            const material = document.getElementById('material').value;
            const unidade = document.getElementById('unidade').value;
            const bruto = document.getElementById('pesoBruto').value;
            const tara = document.getElementById('pesoTara').value;
            const qtd = document.getElementById('quantidade').value;

            // Verificação se está vazio (ignorando 0 e 1 padrão se não foi mexido)
            if (!ticket && !nfe && !fornecedor && !localizacao && !material && !unidade && !tara && !bruto && (qtd == 0 || qtd == 1)) {
                showToast("O formulário já está vazio.", 'warning');
                return;
            }
            
            document.getElementById('ticket').value = '';
            document.getElementById('nfe').value = '';
            document.getElementById('fornecedor').value = '';
            document.getElementById('localizacao').value = '';
            document.getElementById('material').value = '';
            document.getElementById('unidade').value = '';
            document.getElementById('pesoTara').value = '';
            document.getElementById('pesoBruto').value = '';
            document.getElementById('quantidade').value = '0';
            
            unlockSessionFields();
            calcularPesos();
            showToast("Campos limpos com sucesso.", 'success');
        }

        // --- HISTÓRICO ---
        function renderHistory() {
            const db = getDb();
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = '';
            // Mostra apenas os últimos 50 registros para não pesar
            db.slice(0, 50).forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.material}</td>
                    <td>${item.local || '-'}</td>
                    <td style="font-weight:bold; color:var(--primary);">${item.quantidade}</td>
                    <td>${item.bruto}</td>
                    <td>${item.tara}</td>
                    <td style="font-weight:bold;">${item.liquido}</td>
                    <td><button class="btn-danger" style="padding:5px 8px;" onclick="removerItem(${item.id})"><i class="fa-solid fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function removerItem(id) {
            if(confirm('Excluir este registro?')) {
                let db = getDb();
                db = db.filter(item => item.id !== Number(id));
                saveDb(db);
                showToast("Registro removido.");
            }
        }

        // --- ETIQUETA EM LOTE ---
        function gerarHtmlEtiqueta(dados, indiceAtual, total) {
            return `
            <div class="etiqueta-individual">
                <div style="text-align: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 10px;">
                    <img src="photos/logo-latem.png" style="max-height: 50px; display: block; margin: 0 auto 5px auto;" alt="Logo Latem">
                    <span style="font-size: 12px; font-weight: bold; display: block;">IDENTIFICAÇÃO DE MATÉRIA PRIMA</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; font-size: 12px;">
                    <div style="text-align: left; width: 45%;">
                        <div><strong>DATA:</strong> ${dados.data}</div>
                        <div style="margin-top: 2px;"><strong>HORA:</strong> ${dados.hora}</div>
                        <div style="margin-top: 2px;"><strong>RESP:</strong> ${dados.responsavel.toUpperCase()}</div>
                    </div>
                    <div style="text-align: right; width: 55%;">
                        <div><strong>TICKET:</strong> ${dados.ticket}</div>
                        <div style="margin-top: 2px;"><strong>FORNECEDOR:</strong> ${dados.fornecedor || '---'}</div>
                        <div style="margin-top: 2px;"><strong>MATERIAL:</strong> ${dados.material}</div>
                    </div>
                </div>

                <div style="text-align: center; border-top: 1px dashed black; border-bottom: 1px dashed black; padding: 10px 0; margin: 10px 0; font-size: 14px;">
                    <div style="display: flex; justify-content: space-around; font-weight: bold;">
                        <span>BRUTO: ${dados.bruto} KG</span>
                        <span>TARA: ${dados.tara} KG</span>
                    </div>
                    <div style="font-size: 18px; font-weight: bold; margin-top: 5px;">
                        LÍQUIDO: ${dados.liquido} KG
                    </div>
                    <div style="font-size: 18px; font-weight: bold; margin-top: 5px;">
                        VOLUME: ${indiceAtual}/${total}
                    </div>
                </div>
                
                <div style="margin-top: 10px; text-align: center;">
                    <div style="font-family: 'Libre Barcode 128', cursive; font-size: 40px;">*${dados.ticket}*</div>
                    <div style="font-size:10px;">${dados.ticket}</div>
                </div>
            </div>
            `;
        }

        function mostrarModalEtiquetaLote(registro) {
            const container = document.getElementById('etiquetaScrollArea');
            container.innerHTML = '';
            
            const qtdTotal = registro.quantidade;
            
            // Loop para gerar as N etiquetas do registro único
            for(let i = 1; i <= qtdTotal; i++) {
                container.innerHTML += gerarHtmlEtiqueta(registro, i, qtdTotal);
            }
            
            document.getElementById('etiquetaModal').style.display = 'flex';
        }

        function fecharEtiqueta() { document.getElementById('etiquetaModal').style.display = 'none'; }
        
        function imprimirEtiqueta() { 
            document.body.classList.add('printing-label'); 
            window.print(); 
            document.body.classList.remove('printing-label'); 
        }

        // --- RELATÓRIO ---
        function gerarRelatorio() {
            const db = getDb();
            const now = new Date();
            const dataAtual = now.toLocaleDateString('pt-BR');
            const horaAtual = now.toLocaleTimeString('pt-BR');
            const user = localStorage.getItem('latem_id_user') || 'Desconhecido';

            if(db.length === 0) {
                showToast("Não há registros para gerar relatório.", 'warning');
                return;
            }

            // Cálculos Totais
            let totalBruto = 0;
            let totalTara = 0;
            let totalLiquido = 0;
            
            const tickets = new Set();
            const fornecedores = new Set();
            const notas = new Set();
            
            const refItem = db[0]; 
            const fileName = `REL_ID_${dataAtual.replace(/\//g, '-')}_${refItem.fornecedor}`;
            document.body.setAttribute('data-filename', fileName);

            let rows = '';

            db.forEach(item => {
                // O peso inserido já é o total de todos juntos (não precisa multiplicar pela qtd)
                totalBruto += parseFloat(item.bruto || 0);
                totalTara += parseFloat(item.tara || 0);
                totalLiquido += parseFloat(item.liquido || 0);
                
                tickets.add(item.ticket);
                if(item.fornecedor) fornecedores.add(item.fornecedor);
                if(item.nfe) notas.add(item.nfe);

                rows += `
                    <tr>
                        <td>${item.ticket}</td>
                        <td>${item.material}</td>
                        <td>${item.local || '-'}</td>
                        <td>${item.unidade || '-'}</td>
                        <td>${item.quantidade}</td>
                        <td>${item.bruto}</td>
                        <td>${item.tara}</td>
                        <td>${item.liquido}</td>
                    </tr>
                `;
            });

            // Cabeçalho resumido se houver múltiplos
            const ticketDisplay = tickets.size === 1 ? Array.from(tickets)[0] : "Diversos";
            const fornDisplay = fornecedores.size === 1 ? Array.from(fornecedores)[0] : (fornecedores.size > 0 ? "Diversos" : "---");
            const notaDisplay = notas.size === 1 ? Array.from(notas)[0] : (notas.size > 0 ? "Diversas" : "---");

            const html = `
                <div class="relatorio-header">
                    <img src="photos/logo-latem.png" style="max-height: 60px; margin-bottom: 10px;" alt="Logo Latem">
                    <h2>Relatório de Identificação de Matéria Prima</h2>
                </div>

                <div class="relatorio-info">
                    <!-- Coluna Esquerda -->
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <div><strong>Data:</strong> ${dataAtual}</div>
                        <div><strong>Hora:</strong> ${horaAtual}</div>
                        <div><strong>Responsável:</strong> ${user.toUpperCase()}</div>
                    </div>
                    
                    <!-- Coluna Direita -->
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <div><strong>Ticket:</strong> ${ticketDisplay}</div>
                        <div><strong>Nota Fiscal:</strong> ${notaDisplay}</div>
                        <div><strong>Fornecedor:</strong> ${fornDisplay}</div>
                    </div>

                    <!-- Totais -->
                    <div style="grid-column: span 2; margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px; display: grid; grid-template-columns: 1fr 1fr 1.5fr;">
                        <div><strong>Peso Bruto Total:</strong> ${totalBruto.toFixed(2)} kg</div>
                        <div><strong>Tara Total:</strong> ${totalTara.toFixed(2)} kg</div>
                        <div><strong>Peso Líquido Total:</strong> ${totalLiquido.toFixed(2)} kg</div>
                    </div>
                </div>

                <table class="relatorio-table">
                    <thead>
                        <tr>
                            <th>Lote/Ticket</th>
                            <th>Material</th>
                            <th>Local</th>
                            <th>Unidade</th>
                            <th>Qtd</th>
                            <th>Bruto</th>
                            <th>Tara</th>
                            <th>Líquido</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;

            document.getElementById('relatorioConteudo').innerHTML = html;
            document.getElementById('relatorioModal').style.display = 'flex';
        }

        function fecharRelatorio() {
            document.getElementById('relatorioModal').style.display = 'none';
        }

        function imprimirRelatorioReal() {
            const originalTitle = document.title;
            const newTitle = document.body.getAttribute('data-filename') || 'Relatorio_Identificacao';
            document.title = newTitle; 

            document.body.classList.add('printing-report');
            window.print();
            document.body.classList.remove('printing-report');
            
            document.title = originalTitle;
            
            // --- NOVA LÓGICA DE LIMPEZA APÓS IMPRESSÃO ---
            localStorage.removeItem('latem_db_id_v2'); // Apaga o banco de dados
            renderHistory(); // Limpa a tabela visualmente
            
            // Para limpar o formulário, precisamos desbloquear e zerar
            document.getElementById('ticket').value = '';
            document.getElementById('nfe').value = '';
            document.getElementById('fornecedor').value = '';
            document.getElementById('localizacao').value = '';
            document.getElementById('material').value = '';
            document.getElementById('unidade').value = '';
            document.getElementById('pesoTara').value = '';
            document.getElementById('pesoBruto').value = '';
            document.getElementById('quantidade').value = '0';
            
            unlockSessionFields();
            calcularPesos();
            
            fecharRelatorio();
            showToast("Relatório impresso e dados apagados.", 'success');
        }

        // Checa se há sessão ativa
        function checkActiveSession() {
            const db = getDb();
            if (db.length > 0) {
                lockSessionFields();
                const last = db[0];
                document.getElementById('ticket').value = last.ticket;
                document.getElementById('nfe').value = last.nfe || '';
                document.getElementById('fornecedor').value = last.fornecedor;
            }
        }

        renderHistory();
        checkActiveSession();
    </script>
</body>
</html>