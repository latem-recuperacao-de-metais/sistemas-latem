<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pesagem</title>
    <!-- Fontes Principais -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Fonte para Código de Barras -->
    <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+128&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --display-bg: #0f172a;
            --display-text: #38bdf8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- Toast Notifications --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 11000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease-out forwards;
            border-left: 5px solid var(--primary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.warning { border-left-color: var(--warning); }
        .toast.info { border-left-color: var(--primary); }

        .toast i { font-size: 1.2rem; }
        .toast.success i { color: var(--success); }
        .toast.error i { color: var(--danger); }
        .toast.warning i { color: var(--warning); }
        .toast.info i { color: var(--primary); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 80px;
            background-color: var(--display-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            transition: width 0.3s;
            z-index: 10;
        }
        
        .sidebar:hover {
            width: 200px;
        }

        .logo-area {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
            overflow: hidden;
            background: white;
            padding: 5px;
        }
        
        .logo-area img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .nav-item {
            width: 100%;
            display: flex;
            align-items: center;
            padding: 15px 0;
            cursor: pointer;
            color: #94a3b8;
            transition: 0.2s;
            text-decoration: none;
        }

        .nav-item:hover, .nav-item.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border-left: 4px solid var(--primary);
        }

        .nav-icon {
            width: 80px;
            text-align: center;
            font-size: 1.2rem;
        }

        .nav-text {
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .sidebar:hover .nav-text {
            opacity: 1;
        }

        /* --- Main Content --- */
        .main-content {
            flex: 1;
            padding: 20px;
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: auto 1fr;
            gap: 20px;
            height: 100vh;
        }

        header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            padding: 10px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        /* Header Components */
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #fee2e2;
            color: var(--danger);
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
        }

        .status-badge.connected {
            background: #dcfce7;
            color: var(--success);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            box-shadow: 0 0 5px currentColor;
        }

        .header-center {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .clock-display {
            background: #f1f5f9;
            padding: 5px 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: var(--primary);
        }

        .user-info { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .user-avatar { width: 35px; height: 35px; background: var(--secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; }

        /* --- Cards --- */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 10px;
        }

        /* --- Form Section (Left) --- */
        .form-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            position: relative;
        }

        label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select, textarea {
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            outline: none;
            transition: 0.2s;
            background: #f8fafc;
            width: 100%;
        }

        /* Estilo para campos bloqueados */
        input:read-only, select:disabled {
            background-color: #e2e8f0;
            color: #64748b;
            cursor: not-allowed;
            border-color: #cbd5e1;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* --- Scale Display (Right) --- */
        .scale-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: hidden;
        }

        .display-container {
            background: var(--display-bg);
            color: var(--display-text);
            padding: 20px 30px;
            border-radius: 16px;
            text-align: right;
            position: relative;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 150px;
            flex-shrink: 0;
        }

        .display-label {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 600;
            text-transform: uppercase;
        }

        .weight-value {
            font-family: 'Courier New', monospace;
            font-size: 4.5rem;
            font-weight: 700;
            letter-spacing: -4px;
            line-height: 1;
            text-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
        }

        .display-offline .weight-value {
            color: #334155; /* Dimmed when offline */
            text-shadow: none;
        }

        .unit {
            font-size: 1.5rem;
            color: #64748b;
            position: absolute;
            bottom: 25px;
            right: 30px;
        }
        
        /* --- Weight Controls --- */
        .weight-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            flex-shrink: 0;
        }

        .weight-input-card {
            background: #f8fafc;
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .weight-input-card label { margin-bottom: 5px; display: block; }

        .weight-input-card input {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-main);
            text-align: right;
            border: none;
            background: transparent;
            border-bottom: 2px solid #cbd5e1;
            border-radius: 0;
            padding: 5px 0;
        }
        
        /* BLOQUEADO (READONLY) no peso - estilo visual para parecer display */
        .weight-input-card input[readonly] {
            color: var(--secondary);
            background: transparent;
            cursor: not-allowed;
            border-bottom-style: dashed;
        }

        .weight-input-card.highlight {
            background: #ecfdf5;
            border-color: #a7f3d0;
        }
        .weight-input-card.highlight input {
            color: var(--success);
            border-color: var(--success);
        }

        /* --- Action Buttons --- */
        .actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            flex-shrink: 0;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        
        .btn-secondary { background: white; border: 1px solid #cbd5e1; color: var(--text-main); }
        .btn-secondary:hover { background: #f1f5f9; }

        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { filter: brightness(0.9); }
        
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #b91c1c; }

        /* --- History Table --- */
        .history-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-top: 10px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        .table-container {
            overflow-y: auto;
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th {
            text-align: left;
            padding: 12px;
            background: #f8fafc;
            color: var(--secondary);
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
        }

        tr:hover { background: #f1f5f9; }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            width: 400px;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .etiqueta-modal {
            background: white;
            padding: 10px;
            width: 350px;
            border: 1px solid #ccc;
            font-family: 'Courier New', monospace;
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        
        /* Modal Relatório */
        .relatorio-modal {
            background: white;
            width: 800px;
            max-height: 90vh;
            border-radius: 8px;
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            overflow: hidden;
            flex-direction: column;
        }

        .relatorio-content {
            padding: 40px;
            overflow-y: auto;
            flex: 1;
            font-family: Arial, sans-serif;
            color: black;
        }

        .relatorio-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
        }

        .relatorio-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px; 
            margin-bottom: 20px;
            font-size: 14px;
            border: 1px solid #ccc;
            padding: 15px;
            background: #f9f9f9;
        }

        .relatorio-info div {
            margin-bottom: 5px;
        }
        
        .relatorio-info strong {
            display: inline-block;
            width: 100px; 
        }

        .relatorio-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
        }

        .relatorio-table th, .relatorio-table td {
            border: none;
            padding: 8px;
            text-align: left;
        }
        
        .relatorio-table tbody tr {
            border-bottom: 1px solid #f0f0f0;
        }

        .relatorio-table th {
            background: #eee;
            font-weight: bold;
            border-bottom: 2px solid #000;
        }
        
        .user-modal-box {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 700px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .hidden { display: none !important; }

        @media (max-width: 1024px) {
            .main-content { grid-template-columns: 1fr; overflow-y: auto; }
            body { overflow: auto; }
            .sidebar { display: none; }
            .actions { grid-template-columns: 1fr; }
            .scale-section { overflow: visible; }
        }

        /* --- PRINT STYLES --- */
        @media print {
            @page { margin: 10mm; }
            body { 
                background: white; 
                height: auto; 
                overflow: visible; 
                display: block; 
            }
            
            #toast-container { display: none !important; }
            .sidebar, .actions, .form-section, .weight-controls, #scaleStatus, .user-info, .btn, .scale-section, #userModal, #loginModal, .main-content {
                display: none !important;
            }

            /* --- MODO RELATÓRIO A4 --- */
            body.printing-report .relatorio-modal {
                display: block !important;
                position: relative !important;
                transform: none !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                max-height: none !important;
                box-shadow: none !important;
                border: none !important;
            }
            
            body.printing-report .relatorio-content {
                padding: 0;
                overflow: visible;
            }
            
            body.printing-report .relatorio-footer {
                display: none;
            }

            /* --- MODO ETIQUETA ZD220 --- */
            body.printing-label { width: 100mm; margin: 0; }
            body.printing-label .etiqueta-modal {
                display: block !important;
                position: static !important;
                transform: none !important;
                width: 100% !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 !important;
            }
            body.printing-label .etiqueta-modal button { display: none !important; }
            .etiqueta-print-content {
                width: 95mm; 
                margin: 0 auto;
                font-size: 12px;
                font-family: sans-serif;
                color: black;
            }
        }
    </style>
</head>
<body>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="modal-overlay">
        <div class="login-box">
            <!-- Imagem substituindo o ícone de balança -->
            <div style="margin-bottom: 20px; display: flex; justify-content: center;">
                <img src="photos/logo-mp.png" alt="Logo MP" style="max-height: 100px; max-width: 100%;">
            </div>
            <h2 style="margin-bottom: 10px;">Sistema de Pesagem de Materia Prima</h2>
            <p style="color: var(--secondary); margin-bottom: 25px;">Acesso ao Sistema</p>
            
            <form id="loginForm" class="input-group">
                <!-- Dropdown de Usuários -->
                <select id="username" required>
                    <option value="">Selecione um usuário...</option>
                </select>
                <input type="password" id="password" placeholder="Senha" required style="margin-top: 10px;">
                <button type="submit" class="btn btn-primary" style="margin-top: 20px; width: 100%;">Entrar</button>
            </form>
            <p id="loginError" style="color: var(--danger); font-size: 0.8rem; margin-top: 10px;" class="hidden">Senha incorreta.</p>
        </div>
    </div>

    <!-- USER MANAGEMENT MODAL -->
    <div id="userModal" class="modal-overlay hidden">
        <div class="user-modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3><i class="fa-solid fa-users-gear"></i> Gerenciar Usuários</h3>
                <button class="btn-secondary" style="padding:5px 10px;" onclick="closeUserModal()"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: #f8fafc; border-radius: 8px;">
                <div class="input-group">
                    <label>Novo Usuário</label>
                    <input type="text" id="newUsername" placeholder="Nome">
                </div>
                <div class="input-group">
                    <label>Senha</label>
                    <input type="password" id="newPassword" placeholder="Senha">
                </div>
                <div class="input-group" style="grid-column: span 2;">
                     <button class="btn btn-primary" onclick="createNewUser()">Criar Usuário</button>
                </div>
            </div>

            <div class="table-container" style="max-height: 300px;">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Usuário</th>
                            <th>Senha</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ETIQUETA MODAL (Preview e Impressão) -->
    <div id="etiquetaModal" class="etiqueta-modal">
        <div id="etiquetaConteudo" class="etiqueta-print-content">
            <!-- Conteúdo dinâmico -->
        </div>
        <div style="margin-top: 15px; text-align: center; border-top: 1px solid #eee; padding-top: 10px;">
            <button class="btn btn-primary" onclick="imprimirEtiqueta()" style="width: 100%; margin-bottom: 5px;">Imprimir Agora</button>
            <button class="btn btn-secondary" onclick="fecharEtiqueta()" style="width: 100%;">Fechar</button>
        </div>
    </div>

    <!-- RELATÓRIO MODAL (Preview e Impressão) -->
    <div id="relatorioModal" class="relatorio-modal">
        <div id="relatorioConteudo" class="relatorio-content">
            <!-- Conteúdo dinâmico -->
        </div>
        <div class="relatorio-footer" style="padding: 15px; text-align: center; border-top: 1px solid #eee; background: #fff;">
            <button class="btn btn-primary" onclick="imprimirRelatorioReal()" style="width: 100%; margin-bottom: 5px;">Imprimir Relatório</button>
            <button class="btn btn-secondary" onclick="fecharRelatorio()" style="width: 100%;">Fechar</button>
        </div>
    </div>

    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="logo-area">
            <img src="photos/logo-latem.png" alt="Logo Latem">
        </div>
        
        <a href="#" class="nav-item active">
            <div class="nav-icon"><i class="fa-solid fa-scale-balanced"></i></div>
            <span class="nav-text">Pesagem</span>
        </a>

        <a href="#" class="nav-item" onclick="openUserModal()">
            <div class="nav-icon"><i class="fa-solid fa-users"></i></div>
            <span class="nav-text">Usuários</span>
        </a>

        <div style="margin-top: auto; width: 100%; margin-bottom: 20px;">
            <a href="#" class="nav-item" onclick="logout()">
                <div class="nav-icon"><i class="fa-solid fa-right-from-bracket"></i></div>
                <span class="nav-text">Sair</span>
            </a>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        
        <!-- Header -->
        <header>
            <div class="header-left">
                <!-- Botão de Conexão com Balança via Serial -->
                <div id="scaleStatus" class="status-badge" onclick="conectarBalanca()">
                    <div class="status-dot"></div>
                    <span id="statusText">Desconectada (Clique para conectar)</span>
                </div>
            </div>

            <div class="header-center">
                <i class="fa-regular fa-clock" style="color: var(--primary);"></i>
                <div class="clock-display" id="clock">00:00:00</div>
                <div style="font-size: 0.9rem; color: var(--secondary);" id="date">01/01/2024</div>
            </div>

            <div class="user-info">
                <span id="userNameDisplay">Operador</span>
                <div class="user-avatar"><i class="fa-solid fa-user"></i></div>
            </div>
        </header>

        <!-- Coluna Esquerda: Formulário -->
        <div class="card form-section">
            <div class="card-title">
                <span><i class="fa-solid fa-file-invoice"></i> Dados do Ticket</span>
            </div>
            
            <div class="input-group">
                <label>Nº Ticket</label>
                <input type="text" id="ticket" placeholder="Insira o Ticket da Pesagem da Balança Rodoviária">
            </div>

            <div class="input-group">
                <label>Nota Fiscal</label>
                <input type="text" id="nfe" placeholder="000.000.000">
            </div>

            <div class="input-group">
                <label>Fornecedor</label>
                <input type="text" id="fornecedor" placeholder="Ex: Castilho, Latem...">
            </div>

            <div class="input-group">
                <label>Material</label>
                <input type="text" id="material" placeholder="Ex: Cavaco, Perfil...">
            </div>

            <div class="input-group">
                <label>Localização</label>
                <input type="text" id="localizacao" placeholder="Ex: RB, Casinha de Borra">
            </div>

            <div class="input-group">
                <label>Unidade</label>
                <input type="text" id="unidade" placeholder="Ex: Bag, Pallet">
            </div>
            
            <div style="margin-top: auto; padding-top: 10px; text-align: center;">
                 <button class="btn btn-secondary" onclick="limparTudo()" style="width: 100%;">
                    <i class="fa-solid fa-eraser"></i> Limpar Tudo
                </button>
            </div>
        </div>

        <!-- Coluna Direita: Balança, Ações E HISTÓRICO -->
        <div class="scale-section">
            
            <!-- Display Principal -->
            <div id="displayContainer" class="display-container display-offline">
                <div class="display-label">PESO LÍQUIDO</div>
                <div class="weight-value" id="displayLiquido">----</div>
                <div class="unit">KG</div>
            </div>
            
            <!-- Inputs de Peso -->
            <div class="weight-controls">
                <div class="weight-input-card">
                    <label>Peso Bruto (kg)</label>
                    <!-- Somente Leitura - Vem da Serial -->
                    <input type="number" id="pesoBruto" value="0" readonly oninput="calcularPesos()">
                </div>

                <div class="weight-input-card" style="border-left: 4px solid var(--primary);">
                    <label>Tara (kg)</label>
                    <input type="number" id="pesoTara" placeholder="0" oninput="calcularPesos()">
                </div>

                <div class="weight-input-card highlight">
                    <label>Líquido (kg)</label>
                    <input type="number" id="pesoLiquido" value="0" readonly>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="actions">
                <button class="btn btn-primary" onclick="realizarPesagem()">
                    <i class="fa-solid fa-scale-balanced"></i> Pesar
                </button>
                <button class="btn btn-warning" onclick="gerarRelatorio()">
                    <i class="fa-solid fa-print"></i> Relatório
                </button>
            </div>

            <!-- HISTÓRICO -->
            <div class="history-section">
                <div class="card-title" style="margin-bottom: 10px;">
                    <i class="fa-solid fa-list-check"></i> Registros
                </div>
                <div class="table-container">
                    <table id="historyTable">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Localização</th>
                                <th>Peso Bruto</th>
                                <th>Tara</th>
                                <th>Peso Líquido</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

        </div>

    </main>

    <script>
        // --- TOAST NOTIFICATIONS ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = 'check-circle';
            if(type === 'error') icon = 'circle-exclamation';
            if(type === 'warning') icon = 'triangle-exclamation';
            if(type === 'info') icon = 'circle-info';

            toast.innerHTML = `<i class="fa-solid fa-${icon}"></i> <span>${message}</span>`;
            
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease-out forwards';
                setTimeout(() => {
                    toast.remove();
                }, 500);
            }, 3000);
        }

        // --- RELÓGIO E DATA ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('pt-BR');
            document.getElementById('date').innerText = now.toLocaleDateString('pt-BR');
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- INTEGRAÇÃO COM BALANÇA (WEB SERIAL API) E TRAVA DE JANELA ---
        let scaleConnected = false;
        let serialPort = null;
        let serialReader = null;
        let keepReading = false;

        // Limpa a flag de balança caso o usuário feche a aba bruscamente
        window.addEventListener('beforeunload', async (e) => {
            if (scaleConnected) {
                keepReading = false;
                if (serialReader) await serialReader.cancel();
                if (serialPort) await serialPort.close();
                localStorage.removeItem('latem_scale_connected');
            }
        });

        async function conectarBalanca() {
            // Se já estiver conectado NESTA janela, desconecta
            if (scaleConnected) {
                keepReading = false;
                if (serialReader) await serialReader.cancel();
                if (serialPort) await serialPort.close();
                scaleConnected = false;
                localStorage.removeItem('latem_scale_connected');
                updateStatus(false);
                showToast('Balança desconectada.', 'info');
                return;
            }

            // Verifica suporte
            if (!('serial' in navigator)) {
                showToast('Seu navegador não suporta a conexão automática. Use Chrome ou Edge.', 'error');
                return;
            }

            // Verifica se tem flag ativa de OUTRA aba
            if (localStorage.getItem('latem_scale_connected') === 'true') {
                showToast('Aviso: Feche o sistema de pesagem que já está aberto ou conectado à balança em outra aba/janela.', 'error');
            }

            try {
                serialPort = await navigator.serial.requestPort();
                await serialPort.open({ baudRate: 9600 });
                
                scaleConnected = true;
                keepReading = true;
                localStorage.setItem('latem_scale_connected', 'true');
                updateStatus(true);
                showToast('Balança conectada com sucesso!');
                readSerialLoop();
            } catch (err) {
                console.error('Erro ao conectar:', err);
                
                // Trata especificamente o erro de porta ocupada por outro programa/aba
                if (err.message.toLowerCase().includes('open') || err.message.toLowerCase().includes('in use') || err.name === 'NetworkError') {
                    showToast('Aviso: Feche o sistema de pesagem que já está aberto ou conectado à balança.', 'error');
                } else {
                    showToast('Falha ao conectar: ' + err.message, 'error');
                }
                
                scaleConnected = false;
                updateStatus(false);
            }
        }

        function updateStatus(isConnected) {
            const badge = document.getElementById('scaleStatus');
            const text = document.getElementById('statusText');
            const display = document.getElementById('displayContainer');
            const brutoInput = document.getElementById('pesoBruto');

            if (isConnected) {
                badge.classList.add('connected');
                text.innerText = "Conectada";
                display.classList.remove('display-offline');
                brutoInput.readOnly = true; 
            } else {
                badge.classList.remove('connected');
                text.innerText = "Desconectada (Clique para conectar)";
                display.classList.add('display-offline');
                document.getElementById('displayLiquido').innerText = "----";
                brutoInput.value = 0;
            }
        }

        async function readSerialLoop() {
            const textDecoder = new TextDecoderStream();
            const readableStreamClosed = serialPort.readable.pipeTo(textDecoder.writable);
            const reader = textDecoder.readable.getReader();
            serialReader = reader;
            let buffer = '';

            try {
                while (keepReading) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    if (value) {
                        buffer += value;
                        if (buffer.includes('\r') || buffer.includes('\n')) {
                            const lines = buffer.split(/[\r\n]+/);
                            const lastData = lines.filter(l => l.trim().length > 0).pop();
                            if (lastData) parseWeight(lastData);
                            buffer = ''; 
                        }
                    }
                }
            } catch (error) {
                console.error('Erro de leitura:', error);
                showToast('Erro na leitura da balança.', 'error');
            } finally {
                reader.releaseLock();
            }
        }

        function parseWeight(dataString) {
            const match = dataString.match(/(\d+(\.\d+)?)/);
            if (match && match[0]) {
                let weight = parseFloat(match[0]);
                document.getElementById('pesoBruto').value = weight;
                calcularPesos();
            }
        }
        
        // --- GERENCIAMENTO DE USUÁRIOS ---
        const DEFAULT_USERS = [
            { user: 'admin', pass: 'admin', role: 'admin' },
            { user: 'operador', pass: '1234', role: 'user' }
        ];

        function getUsers() { return JSON.parse(localStorage.getItem('latem_users')) || DEFAULT_USERS; }
        function saveUsers(users) { localStorage.setItem('latem_users', JSON.stringify(users)); }

        // Renderiza o select de usuários no login
        function renderUserSelect() {
            const users = getUsers();
            const select = document.getElementById('username');
            select.innerHTML = '<option value="">Selecione um usuário...</option>';
            users.forEach(u => {
                const option = document.createElement('option');
                option.value = u.user;
                option.textContent = u.user;
                select.appendChild(option);
            });
        }

        function openUserModal() {
            const currentUser = localStorage.getItem('latem_user');
            const users = getUsers();
            const userObj = users.find(u => u.user === currentUser);
            if (userObj && userObj.role === 'admin') {
                document.getElementById('userModal').classList.remove('hidden');
                renderUsersTable();
            } else {
                showToast("Acesso negado. Apenas administradores.", 'error');
            }
        }

        function closeUserModal() { document.getElementById('userModal').classList.add('hidden'); }

        function renderUsersTable() {
            const users = getUsers();
            const currentUser = localStorage.getItem('latem_user');
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            users.forEach(u => {
                const tr = document.createElement('tr');
                let buttons = '';
                if (u.user !== currentUser) buttons += `<button class="btn-danger" style="padding:5px 10px; margin-right:5px;" onclick="deleteUser('${u.user}')"><i class="fa-solid fa-trash"></i></button>`;
                buttons += `<button class="btn-warning" style="padding:5px 10px;" onclick="changePassword('${u.user}')"><i class="fa-solid fa-key"></i></button>`;
                tr.innerHTML = `<td>${u.user} ${u.role==='admin'?'<span style="font-size:0.7rem;background:#ddd;padding:2px 4px;border-radius:4px;">Admin</span>':''}</td><td>******</td><td>${buttons}</td>`;
                tbody.appendChild(tr);
            });
        }

        function createNewUser() {
            const newUser = document.getElementById('newUsername').value;
            const newPass = document.getElementById('newPassword').value;
            if(!newUser || !newPass) return showToast("Preencha usuário e senha.", 'warning');
            const users = getUsers();
            if(users.find(u => u.user === newUser)) return showToast("Usuário já existe.", 'error');
            users.push({ user: newUser, pass: newPass, role: 'user' });
            saveUsers(users);
            renderUsersTable();
            renderUserSelect(); // Atualiza select se estiver visivel
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            showToast("Usuário criado com sucesso!");
        }

        function deleteUser(username) {
            if(confirm(`Excluir ${username}?`)) {
                let users = getUsers();
                users = users.filter(u => u.user !== username);
                saveUsers(users);
                renderUsersTable();
                renderUserSelect();
                showToast("Usuário excluído.");
            }
        }

        function changePassword(username) {
            const newPass = prompt(`Nova senha para ${username}:`);
            if(newPass) {
                let users = getUsers();
                const idx = users.findIndex(u => u.user === username);
                if(idx !== -1) { users[idx].pass = newPass; saveUsers(users); showToast("Senha alterada."); }
            }
        }

        // --- AUTENTICAÇÃO ---
        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        
        // Init
        if(!localStorage.getItem('latem_users')) saveUsers(DEFAULT_USERS);
        renderUserSelect(); // Preenche o dropdown

        if(localStorage.getItem('latem_user')) {
            loginModal.classList.add('hidden');
            document.getElementById('userNameDisplay').innerText = localStorage.getItem('latem_user');
            checkActiveSession(); // Checa sessão em aberto ao carregar
            
            // Tenta reconectar a balança silenciosamente (caso já tenha sido autorizada antes)
            autoConnectScale(); 
        }
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const users = getUsers();
            const found = users.find(u => u.user === user && u.pass === pass);
            if (found) {
                localStorage.setItem('latem_user', found.user);
                loginModal.classList.add('hidden');
                document.getElementById('userNameDisplay').innerText = found.user;
                showToast("Login realizado com sucesso!", "success");
                checkActiveSession(); // Checa sessão logo após login
                
                // Abre a janela de conexão COM ou conecta direto após o clique do botão Entrar
                await conectarAoLogar();
            } else { document.getElementById('loginError').classList.remove('hidden'); }
        });
        
        // Função para reconexão 100% silenciosa (se já tem permissão salva no navegador)
        async function autoConnectScale() {
            if (!('serial' in navigator)) return;
            if (localStorage.getItem('latem_scale_connected') === 'true' && !scaleConnected) return; // Proteção de aba ocupada
            
            try {
                const ports = await navigator.serial.getPorts();
                if (ports.length > 0) {
                    serialPort = ports[0];
                    await serialPort.open({ baudRate: 9600 });
                    scaleConnected = true;
                    keepReading = true;
                    localStorage.setItem('latem_scale_connected', 'true');
                    updateStatus(true);
                    showToast('Balança reconectada automaticamente!');
                    readSerialLoop();
                }
            } catch (err) {
                console.log("Balança não autorizada previamente ou ocupada.", err);
            }
        }

        // Função acionada pelo clique do login (permite abrir janela de permissão)
        async function conectarAoLogar() {
            if (!('serial' in navigator)) return;
            if (localStorage.getItem('latem_scale_connected') === 'true' && !scaleConnected) {
                showToast('Aviso: Feche o sistema em outra aba antes de conectar.', 'error');
                return;
            }

            try {
                const ports = await navigator.serial.getPorts();
                if (ports.length > 0) {
                    serialPort = ports[0]; // Pega a já autorizada sem perguntar
                } else {
                    serialPort = await navigator.serial.requestPort(); // Pede autorização nova (Abre janela COM)
                }
                
                await serialPort.open({ baudRate: 9600 });
                scaleConnected = true;
                keepReading = true;
                localStorage.setItem('latem_scale_connected', 'true');
                updateStatus(true);
                showToast('Balança conectada com sucesso!');
                readSerialLoop();
            } catch (err) {
                console.log("Conexão no login cancelada ou falhou.", err);
                showToast('Balança não conectada. Use o botão superior quando estiver pronto.', 'info');
            }
        }
        
        function logout() { 
            localStorage.removeItem('latem_user'); 
            showToast("Sessão encerrada com sucesso.", "info");
            setTimeout(() => {
                loginModal.classList.remove('hidden');
                document.getElementById('loginForm').reset();
                document.getElementById('loginError').classList.add('hidden');
                if(scaleConnected) conectarBalanca(); // Desconecta
            }, 1000);
        }

        // --- CÁLCULOS ---
        function calcularPesos() {
            const bruto = parseFloat(document.getElementById('pesoBruto').value) || 0;
            const tara = parseFloat(document.getElementById('pesoTara').value) || 0;
            const liquido = bruto - tara;
            document.getElementById('pesoLiquido').value = liquido;
            const display = document.getElementById('displayLiquido');
            display.innerText = liquido; 
            if(liquido < 0) display.style.color = 'var(--danger)';
            else display.style.color = 'var(--display-text)';
        }

        // --- DATABASE ---
        function getDb() { return JSON.parse(localStorage.getItem('latem_db_v2')) || []; }
        function saveDb(data) { localStorage.setItem('latem_db_v2', JSON.stringify(data)); renderHistory(); }

        // --- BLOQUEIO DE CAMPOS DE SESSÃO ---
        function lockSessionFields() {
            document.getElementById('ticket').readOnly = true;
            document.getElementById('nfe').readOnly = true;
            document.getElementById('fornecedor').readOnly = true;
        }

        function unlockSessionFields() {
            document.getElementById('ticket').readOnly = false;
            document.getElementById('nfe').readOnly = false;
            document.getElementById('fornecedor').readOnly = false;
        }

        // --- PESAR ---
        function realizarPesagem() {
            const ticket = document.getElementById('ticket').value;
            const material = document.getElementById('material').value;
            const fornecedor = document.getElementById('fornecedor').value;
            const bruto = parseFloat(document.getElementById('pesoBruto').value) || 0;
            const tara = document.getElementById('pesoTara').value; // string para checar vazio
            const liquido = document.getElementById('pesoLiquido').value;
            
            if(!ticket) return showToast("O campo Ticket é obrigatório.", 'warning');
            if(!fornecedor) return showToast("O campo Fornecedor é obrigatório.", 'warning');
            if(!material) return showToast("O campo Material é obrigatório.", 'warning');
            if(bruto <= 0) return showToast("Peso inválido. Verifique a balança.", 'warning');

            const registro = {
                id: Date.now(),
                data: new Date().toLocaleDateString('pt-BR'),
                hora: new Date().toLocaleTimeString('pt-BR'),
                ticket,
                nfe: document.getElementById('nfe').value,
                fornecedor,
                local: document.getElementById('localizacao').value,
                material,
                unidade: document.getElementById('unidade').value, 
                bruto,
                tara: tara || 0, // Garante que não vá vazio se não preenchido
                liquido,
                responsavel: localStorage.getItem('latem_user')
            };

            const db = getDb();
            db.unshift(registro); 
            saveDb(db);
            
            // Bloqueia campos da sessão após pesar
            lockSessionFields();
            
            showToast("Pesagem registrada com sucesso!");
            mostrarModalEtiqueta(registro);
            limparFormularioParcial();
        }

        function limparFormularioParcial() {
            document.getElementById('localizacao').value = '';
            document.getElementById('material').value = '';
            document.getElementById('unidade').value = '';
            // Não zera o peso bruto pois ele vem da balança continuamente
            calcularPesos();
        }

        function limparTudo() {
            const ticket = document.getElementById('ticket').value;
            const nfe = document.getElementById('nfe').value;
            const fornecedor = document.getElementById('fornecedor').value;
            const localizacao = document.getElementById('localizacao').value;
            const material = document.getElementById('material').value;
            const unidade = document.getElementById('unidade').value;
            const bruto = document.getElementById('pesoBruto').value;
            const tara = document.getElementById('pesoTara').value;

            if (!ticket && !nfe && !fornecedor && !localizacao && !material && !unidade && !tara) {
                showToast("O formulário já está vazio.", 'warning');
                return;
            }

            document.getElementById('ticket').value = '';
            document.getElementById('nfe').value = '';
            document.getElementById('fornecedor').value = '';
            document.getElementById('localizacao').value = '';
            document.getElementById('material').value = '';
            document.getElementById('unidade').value = '';
            document.getElementById('pesoTara').value = '';
            
            // Desbloqueia campos
            unlockSessionFields();
            
            calcularPesos();
            showToast("Campos limpos com sucesso.", 'success');
        }

        // --- HISTÓRICO ---
        function renderHistory() {
            const db = getDb();
            const tbody = document.querySelector('#historyTable tbody');
            tbody.innerHTML = '';
            db.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.material}</td>
                    <td>${item.local || '-'}</td>
                    <td>${item.bruto} kg</td>
                    <td>${item.tara} kg</td>
                    <td style="color:var(--primary);font-weight:bold;">${item.liquido} kg</td>
                    <td><button class="btn-danger" style="padding:5px 8px;" onclick="removerItem(${item.id})"><i class="fa-solid fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function removerItem(id) {
            if(confirm('Excluir registro?')) {
                let db = getDb();
                db = db.filter(item => item.id !== Number(id));
                saveDb(db);
                
                // Se a lista ficou vazia, libera os campos bloqueados da sessão
                if (db.length === 0) {
                    unlockSessionFields();
                }
                
                showToast("Registro removido.");
            }
        }

        // --- ETIQUETA ---
        function mostrarModalEtiqueta(dados) {
            const html = `
                <div style="text-align: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 10px;">
                    <img src="photos/logo-latem.png" style="max-height: 50px; display: block; margin: 0 auto 5px auto;" alt="Logo Latem">
                    <span style="font-size: 12px; font-weight: bold; display: block;">COMPROVANTE DE PESAGEM</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; font-size: 12px;">
                    <div style="text-align: left;">
                        <div><strong>DATA:</strong> ${dados.data}</div>
                        <div style="margin-top: 2px;"><strong>HORA:</strong> ${dados.hora}</div>
                        <div style="margin-top: 2px;"><strong>RESPONSÁVEL:</strong> ${dados.responsavel.toUpperCase()}</div>
                    </div>
                    <div style="text-align: right;">
                        <div><strong>TICKET:</strong> ${dados.ticket}</div>
                        <div style="margin-top: 2px;"><strong>FORNECEDOR:</strong> ${dados.fornecedor || '---'}</div>
                        <div style="margin-top: 2px;"><strong>MATERIAL:</strong> ${dados.material}</div>
                    </div>
                </div>

                <div style="text-align: center; border-top: 1px dashed black; border-bottom: 1px dashed black; padding: 10px 0; margin: 10px 0; font-size: 12px;">
                    <div><strong>PESO BRUTO:</strong> ${dados.bruto} KG</div>
                    <div><strong>TARA:</strong> ${dados.tara} KG</div>
                    <div style="font-size: 18px; font-weight: bold; margin-top: 5px;">
                        PESO LÍQUIDO: ${dados.liquido} KG
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <div style="font-family: 'Libre Barcode 128', cursive; font-size: 40px;">*${dados.ticket}*</div>
                </div>
            `;
            document.getElementById('etiquetaConteudo').innerHTML = html;
            document.getElementById('etiquetaModal').style.display = 'block';
        }
        function fecharEtiqueta() { document.getElementById('etiquetaModal').style.display = 'none'; }
        function imprimirEtiqueta() { document.body.classList.add('printing-label'); window.print(); document.body.classList.remove('printing-label'); }

        // --- RELATÓRIO ---
        function gerarRelatorio() {
            const db = getDb();
            const now = new Date();
            const dataAtual = now.toLocaleDateString('pt-BR');
            const horaAtual = now.toLocaleTimeString('pt-BR');
            const user = localStorage.getItem('latem_user') || 'Desconhecido';

            if(db.length === 0) {
                showToast("Não há registros para gerar relatório.", 'warning');
                return;
            }

            // Cálculos
            let totalBruto = 0;
            let totalTara = 0;
            let totalLiquido = 0;
            const tickets = new Set();
            const fornecedores = new Set();
            const notas = new Set();
            
            // Dados para o nome do arquivo
            const refItem = db[0]; 
            const fileNameDate = dataAtual.replace(/\//g, '-');
            const fileName = `RPMP_${fileNameDate}_${refItem.material}_${refItem.bruto}kg_${refItem.fornecedor}`;

            document.body.setAttribute('data-filename', fileName);

            let rows = '';

            db.forEach(item => {
                totalBruto += parseFloat(item.bruto || 0);
                totalTara += parseFloat(item.tara || 0);
                totalLiquido += parseFloat(item.liquido || 0);
                tickets.add(item.ticket);
                if(item.fornecedor) fornecedores.add(item.fornecedor);
                if(item.nfe) notas.add(item.nfe);

                rows += `
                    <tr>
                        <td>${item.ticket}</td>
                        <td>${item.material}</td>
                        <td>${item.local || '-'}</td>
                        <td>${item.unidade || '-'}</td>
                        <td>${item.bruto}</td>
                        <td>${item.tara}</td>
                        <td>${item.liquido}</td>
                    </tr>
                `;
            });

            // Resumo para o cabeçalho
            const ticketDisplay = tickets.size === 1 ? Array.from(tickets)[0] : "Diversos";
            const fornDisplay = fornecedores.size === 1 ? Array.from(fornecedores)[0] : (fornecedores.size > 0 ? "Diversos" : "---");
            const notaDisplay = notas.size === 1 ? Array.from(notas)[0] : (notas.size > 0 ? "Diversas" : "---");

            const html = `
                <div class="relatorio-header">
                    <img src="photos/logo-latem.png" style="max-height: 60px; margin-bottom: 10px;" alt="Logo Latem">
                    <h2>Relatório de Pesagem de Matéria Prima</h2>
                </div>

                <div class="relatorio-info">
                    <!-- Coluna Esquerda -->
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <div><strong>Data:</strong> ${dataAtual}</div>
                        <div><strong>Hora:</strong> ${horaAtual}</div>
                        <div><strong>Responsável:</strong> ${user.toUpperCase()}</div>
                    </div>
                    
                    <!-- Coluna Direita -->
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <div><strong>Ticket:</strong> ${ticketDisplay}</div>
                        <div><strong>Nota Fiscal:</strong> ${notaDisplay}</div>
                        <div><strong>Fornecedor:</strong> ${fornDisplay}</div>
                    </div>

                    <!-- Totais -->
                    <div style="grid-column: span 2; margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px; display: grid; grid-template-columns: 1fr 1fr 1.5fr;">
                        <div><strong>Peso Bruto Total:</strong> ${totalBruto.toFixed(2)} kg</div>
                        <div><strong>Tara Total:</strong> ${totalTara.toFixed(2)} kg</div>
                        <div><strong>Peso Líquido Total:</strong> ${totalLiquido.toFixed(2)} kg</div>
                    </div>
                </div>

                <table class="relatorio-table">
                    <thead>
                        <tr>
                            <th>Ticket</th>
                            <th>Material</th>
                            <th>Localização</th>
                            <th>Unidade</th>
                            <th>P. Bruto</th>
                            <th>Tara</th>
                            <th>P. Líquido</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;

            document.getElementById('relatorioConteudo').innerHTML = html;
            document.getElementById('relatorioModal').style.display = 'flex';
        }

        function fecharRelatorio() {
            document.getElementById('relatorioModal').style.display = 'none';
        }

        function imprimirRelatorioReal() {
            const originalTitle = document.title;
            const newTitle = document.body.getAttribute('data-filename') || 'Relatorio_Pesagem';
            document.title = newTitle; 

            document.body.classList.add('printing-report');
            window.print();
            document.body.classList.remove('printing-report');
            
            document.title = originalTitle;
            
            // Limpa tudo e libera campos após impressão
            localStorage.removeItem('latem_db_v2');
            renderHistory();
            unlockSessionFields(); // Libera bloqueio após gerar relatorio definitivo
            limparTudo(); 
            fecharRelatorio();
            showToast("Relatório impresso e sessão finalizada.", 'success');
        }

        // Checa se há sessão ativa ao carregar a página
        function checkActiveSession() {
            const db = getDb();
            // Também dispara aviso caso o usuário recarregue a página com balança "travada" na memória
            if (localStorage.getItem('latem_scale_connected') === 'true' && !scaleConnected) {
                showToast("Aviso: Há um sistema conectado à balança em outra aba. Feche-o antes de conectar.", 'error');
            }

            if (db.length > 0) {
                lockSessionFields();
                // Restaura valores do último registro para contexto
                const last = db[0];
                document.getElementById('ticket').value = last.ticket;
                document.getElementById('nfe').value = last.nfe || '';
                document.getElementById('fornecedor').value = last.fornecedor;
                showToast("Atenção: Existe uma pesagem em andamento que não foi finalizada.", "info");
            }
        }

        renderHistory();
    </script>
</body>
</html>